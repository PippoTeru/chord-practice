<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Practice App</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.container {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    width: 95%;
    max-width: 1400px;
    text-align: center;
}

h1 {
    color: #4a5568;
    margin-bottom: 30px;
    font-size: 2.5em;
    font-weight: 300;
}

h2 {
    color: #4a5568;
    margin-bottom: 20px;
    font-size: 2em;
    font-weight: 400;
}

.game-status {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
    padding: 20px;
    background: #f7fafc;
    border-radius: 10px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.label {
    font-weight: bold;
    color: #4a5568;
}

.timer {
    font-size: 2em;
    font-weight: bold;
    color: #e53e3e;
    min-width: 60px;
}

.score {
    font-size: 2em;
    font-weight: bold;
    color: #38a169;
    min-width: 40px;
}

.unit {
    color: #718096;
}


.controls {
    display: flex;
    justify-content: center;
    gap: 20px;
}

.btn {
    padding: 15px 30px;
    font-size: 1.2em;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 150px;
}

.start-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.start-btn:hover {
    background: linear-gradient(135deg, #38a169, #2f855a);
    transform: translateY(-2px);
}

.restart-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.restart-btn:hover {
    background: linear-gradient(135deg, #3182ce, #2c5282);
    transform: translateY(-2px);
}



.midi-device-selection {
    margin-bottom: 20px;
    padding: 15px;
    background: #f7fafc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    justify-content: center;
}

.device-label {
    font-weight: bold;
    color: #4a5568;
}

.device-select {
    padding: 8px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    background: white;
    color: #4a5568;
    font-size: 1em;
    min-width: 250px;
}

.device-select:focus {
    outline: none;
    border-color: #4299e1;
}

.piano-display {
    margin: 20px 0;
    padding: 0;
    background: transparent;
}

.piano-keyboard {
    position: relative;
    background: transparent;
    width: 100%;
    margin: 0;
    overflow-x: visible;
    display: flex;
    justify-content: center;
}

.piano-key {
    position: absolute;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    font-weight: bold;
    transition: all 0.1s ease;
    border-radius: 0 0 5px 5px;
}

.piano-key.white {
    background: white;
    border: 1px solid #ddd;
    z-index: 1;
    color: #666;
    padding-bottom: 3px;
}

.piano-key.black {
    background: #1a1a1a;
    border: 1px solid #000;
    z-index: 2;
    color: #ccc;
    padding-bottom: 2px;
    border-radius: 0 0 3px 3px;
}

.piano-key.pressed {
    background: #4299e1 !important;
    color: white !important;
    transform: scale(0.95);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

.piano-key.white.left-hand-range.pressed,
.piano-key.white.right-hand-range.pressed {
    background: #4299e1 !important;
    color: white !important;
}

.piano-key.correct {
    background: #48bb78 !important;
    color: white !important;
}

.piano-key.incorrect {
    background: #f56565 !important;
    color: white !important;
}

.piano-key.white.left-hand-range {
    background: rgba(66, 153, 225, 0.3) !important;
}

.piano-key.white.right-hand-range {
    background: rgba(72, 187, 120, 0.3) !important;
}

.screen {
    display: block;
}

.title-header {
    text-align: center;
    margin-bottom: 60px;
}

.music-icon {
    font-size: 4em;
    margin-bottom: 20px;
    animation: bounce 2s ease-in-out infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

.main-title {
    font-size: 3.5em;
    font-weight: bold;
    margin-bottom: 10px;
    color: #4a5568; /* fallback color */
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .main-title {
        font-size: 2.8em;
    }
    
    .music-icon {
        font-size: 3em;
    }
    
    .title-btn {
        width: 240px;
        font-size: 1.2em;
        padding: 18px 25px;
    }
    
    .subtitle {
        font-size: 1.1em;
    }
}

.subtitle {
    font-size: 1.2em;
    color: #718096;
    margin: 0;
    font-weight: normal;
}

.title-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin: 40px 0;
}

.title-btn {
    width: 280px;
    padding: 20px 30px;
    font-size: 1.3em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.title-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.btn-icon {
    font-size: 1.2em;
}

.title-footer {
    margin-top: 40px;
    text-align: center;
}

.description {
    color: #718096;
    font-size: 1em;
    margin: 0;
    font-style: italic;
}

.version-info {
    color: #a0aec0;
    font-size: 0.8em;
    margin: 8px 0 0 0;
    font-family: 'Courier New', monospace;
    opacity: 0.7;
}

.secondary-btn {
    background: linear-gradient(135deg, #718096, #4a5568);
    color: white;
}

.secondary-btn:hover {
    background: linear-gradient(135deg, #4a5568, #2d3748);
    transform: translateY(-2px);
}

.settings-header {
    text-align: center;
    margin-bottom: 40px;
}

.settings-icon {
    font-size: 3em;
    margin-bottom: 15px;
}

.settings-title {
    font-size: 2.2em;
    font-weight: bold;
    margin-bottom: 8px;
    color: #4a5568;
}

.settings-subtitle {
    font-size: 1.1em;
    color: #718096;
    margin: 0;
}

.settings-content {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-bottom: 40px;
}

.midi-section, .audio-section, .instructions-section {
    background: #f8fafc;
    border-radius: 15px;
    padding: 25px;
    border: 1px solid #e2e8f0;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.section-icon {
    font-size: 1.5em;
}

.section-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #4a5568;
    margin: 0;
}

.midi-status {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    background: #fed7d7;
    border: 1px solid #feb2b2;
}

.midi-status.connected {
    background: #c6f6d5;
    border: 1px solid #9ae6b4;
}

.status-icon {
    font-size: 1.2em;
}

.status-content {
    flex: 1;
    font-weight: 500;
    color: #2d3748;
}

.device-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    color: #4a5568;
    margin-bottom: 10px;
    font-size: 1em;
}

.label-icon {
    font-size: 1.1em;
}

.device-select-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
}

.device-select {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    color: #4a5568;
    font-size: 1em;
    appearance: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.device-select:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.select-arrow {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #718096;
    pointer-events: none;
    font-size: 0.8em;
}

.instructions-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.instruction-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px 0;
}

.step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    font-size: 0.9em;
}

.step-text {
    color: #4a5568;
    font-size: 1em;
}

.audio-controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.volume-control {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.volume-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    color: #4a5568;
    font-size: 1em;
}

.volume-slider-wrapper {
    display: flex;
    align-items: center;
    gap: 15px;
}

.volume-slider {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: #e2e8f0;
    outline: none;
    -webkit-appearance: none;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.volume-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.volume-value {
    min-width: 40px;
    font-weight: bold;
    color: #4a5568;
    font-size: 0.9em;
}

.sustain-pedal-indicator {
    background: white;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #e2e8f0;
}

.pedal-status {
    display: flex;
    align-items: center;
    gap: 10px;
}

.pedal-icon {
    font-size: 1.2em;
}

.pedal-label {
    font-weight: bold;
    color: #4a5568;
}

.pedal-state {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.8em;
    min-width: 40px;
    text-align: center;
}

.pedal-state.off {
    background: #fed7d7;
    color: #c53030;
}

.pedal-state.on {
    background: #c6f6d5;
    color: #2d7d32;
}

.audio-info {
    background: white;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #e2e8f0;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.info-icon {
    font-size: 1.1em;
}

.info-text {
    color: #4a5568;
    font-size: 0.9em;
    line-height: 1.4;
}

.settings-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 30px;
}

/* ゲーム画面のスタイル */
.game-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
}

.game-icon {
    font-size: 2em;
}

.game-title {
    font-size: 1.8em;
    font-weight: bold;
    margin: 0;
    color: #4a5568;
}

.difficulty-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
    color: #718096;
    margin-left: auto;
}

.difficulty-label {
    font-weight: 500;
}

.difficulty-value {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 0.85em;
}

.game-status-container {
    margin-bottom: 30px;
}

.game-status {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 25px;
    padding: 0;
    background: transparent;
    border-radius: 0;
}

.status-card {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 12px;
    padding: 15px 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    max-width: 200px;
}

.timer-card {
    border-left: 4px solid #e53e3e;
}

.score-card {
    border-left: 4px solid #38a169;
}

.card-icon {
    font-size: 1.8em;
}

.card-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.card-label {
    font-size: 0.9em;
    font-weight: 500;
    color: #718096;
}

.card-value {
    display: flex;
    align-items: baseline;
    gap: 5px;
}

.timer {
    font-size: 1.8em;
    font-weight: bold;
    color: #e53e3e;
}

.score {
    font-size: 1.8em;
    font-weight: bold;
    color: #38a169;
}

.unit {
    font-size: 0.9em;
    color: #718096;
    font-weight: normal;
}

.chord-section {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}

.chord-header {
    text-align: center;
    margin-bottom: 25px;
}

.chord-instruction {
    font-size: 1.2em;
    color: #4a5568;
    margin: 0;
    font-weight: 500;
}

.chord-display {
    text-align: center;
    padding: 35px 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 15px;
    border: 2px solid #e2e8f0;
    margin-bottom: 25px;
    transition: all 0.3s ease;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
}

.result-display {
    text-align: center;
    padding: 30px 20px;
    background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
    border-radius: 15px;
    border: 2px solid #38a169;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(56, 161, 105, 0.15);
}

.result-display .result-icon {
    font-size: 2.5em;
    margin-bottom: 15px;
}

.result-display .result-title {
    font-size: 1.5em;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 20px;
}

.result-display .final-score-display {
    margin-bottom: 15px;
}

.result-display .score-label {
    font-size: 1em;
    color: #4a5568;
    margin-bottom: 8px;
}

.result-display .score-number {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 8px;
}

.result-display .score-number span:first-child {
    font-size: 2.5em;
    font-weight: bold;
    color: #38a169;
}

.result-display .score-unit {
    font-size: 1.2em;
    color: #4a5568;
}

.result-display .result-message {
    color: #4a5568;
    font-size: 1.1em;
}

#current-chord {
    font-size: 4em;
    font-weight: bold;
    color: #2d3748;
}

.chord-info {
    margin-bottom: 15px;
}

.hand-info {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.hand-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 12px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e2e8f0;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    font-size: 1em;
    font-weight: 600;
    transition: all 0.2s ease;
    min-width: 160px;
}

.hand-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.left-hand {
    border: 2px solid #3182ce;
    background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
    color: #2c5282;
}

.left-hand .hand-icon {
    background: #3182ce;
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
}

.right-hand {
    border: 2px solid #38a169;
    background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
    color: #276749;
}

.right-hand .hand-icon {
    background: #38a169;
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
}


.hand-text {
    font-weight: 600;
    flex: 1;
}

.game-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
}

.game-btn {
    min-width: 140px;
    padding: 15px 25px;
    font-size: 1.1em;
}

.result-area {
    background: transparent;
    padding: 0;
    border-radius: 0;
    margin-bottom: 30px;
}

.result-card {
    background: white;
    border-radius: 20px;
    padding: 40px 30px;
    text-align: center;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
}

.result-icon {
    font-size: 3em;
    margin-bottom: 15px;
}

.result-title {
    font-size: 2em;
    font-weight: bold;
    color: #4a5568;
    margin-bottom: 25px;
}

.final-score-display {
    margin-bottom: 20px;
}

.score-label {
    font-size: 1.1em;
    color: #718096;
    margin-bottom: 10px;
}

.score-number {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 8px;
}

.score-number #final-score {
    font-size: 3em;
    font-weight: bold;
    color: #38a169;
}

.score-unit {
    font-size: 1.2em;
    color: #718096;
}

.result-message {
    color: #4a5568;
    font-size: 1.1em;
}

.piano-display {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 20px;
    padding: 25px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}

@media (max-width: 768px) {
    .settings-content {
        gap: 20px;
    }
    
    .midi-section, .instructions-section {
        padding: 20px;
    }
    
    .settings-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .settings-controls .btn {
        width: 240px;
    }
    
    .game-status {
        flex-direction: column;
        align-items: center;
    }
    
    .status-card {
        width: 100%;
        max-width: 280px;
    }
    
    .hand-info {
        flex-direction: column;
        gap: 15px;
    }
    
    .hand-item {
        justify-content: center;
    }
    
    .game-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .game-btn {
        width: 200px;
    }
    
    #current-chord {
        font-size: 3em;
    }
}

@keyframes correct {
    0% { background: #c6f6d5; }
    100% { background: #f7fafc; }
}

@keyframes incorrect {
    0% { background: #fed7d7; }
    100% { background: #f7fafc; }
}

.chord-display.correct {
    animation: correct 0.5s ease;
}

.chord-display.incorrect {
    animation: incorrect 0.5s ease;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- タイトル画面 -->
        <div id="title-screen" class="screen">
            <div class="title-header">
                <div class="music-icon">🎹</div>
                <h1 class="main-title">Chord Master</h1>
                <p class="subtitle">ピアノコード練習アプリ</p>
            </div>
            <div class="title-controls">
                <button id="game-start-btn" class="btn title-btn start-btn">
                    <span class="btn-icon">🎵</span>
                    <span>ゲームスタート</span>
                </button>
                <button id="settings-btn" class="btn title-btn secondary-btn">
                    <span class="btn-icon">⚙️</span>
                    <span>環境設定</span>
                </button>
            </div>
            <div class="title-footer">
                <p class="description">MIDIキーボードでコードを演奏して練習しよう</p>
                <p class="version-info" id="version-info">v0.1.0</p>
            </div>
        </div>

        <!-- 環境設定画面 -->
        <div id="settings-screen" class="screen" style="display: none;">
            <div class="settings-header">
                <div class="settings-icon">⚙️</div>
                <h2 class="settings-title">環境設定</h2>
                <p class="settings-subtitle">MIDIキーボードの接続設定</p>
            </div>

            <div class="settings-content">
                <div class="midi-section">
                    <div class="section-header">
                        <div class="section-icon">🎹</div>
                        <h3 class="section-title">MIDIデバイス</h3>
                    </div>
                    
                    <div id="midi-status" class="midi-status">
                        <div class="status-icon">
                            <span id="status-indicator">🔴</span>
                        </div>
                        <div class="status-content">
                            <span id="midi-message">MIDIデバイスを接続してください</span>
                        </div>
                    </div>

                    <div id="midi-device-selection" class="midi-device-selection" style="display: none;">
                        <label for="midi-devices" class="device-label">
                            <span class="label-icon">🎼</span>
                            MIDIデバイス選択
                        </label>
                        <div class="device-select-wrapper">
                            <select id="midi-devices" class="device-select">
                                <option value="">デバイスを選択してください</option>
                            </select>
                            <div class="select-arrow">▼</div>
                        </div>
                    </div>
                </div>

                <div class="audio-section">
                    <div class="section-header">
                        <div class="section-icon">🔊</div>
                        <h3 class="section-title">オーディオ設定</h3>
                    </div>
                    
                    <div class="audio-controls">
                        <div class="volume-control">
                            <label for="volume-slider" class="volume-label">
                                <span class="label-icon">🎚️</span>
                                ピアノ音量
                            </label>
                            <div class="volume-slider-wrapper">
                                <input type="range" id="volume-slider" class="volume-slider" 
                                       min="0" max="100" value="100" step="1">
                                <span id="volume-value" class="volume-value">100%</span>
                            </div>
                        </div>
                        <div class="sustain-pedal-indicator">
                            <div class="pedal-status" id="sustain-pedal-status">
                                <span class="pedal-icon">🦶</span>
                                <span class="pedal-label">サスティーンペダル</span>
                                <span class="pedal-state" id="pedal-state">OFF</span>
                            </div>
                        </div>
                        <div class="audio-info">
                            <div class="info-item">
                                <span class="info-icon">ℹ️</span>
                                <span class="info-text">MIDIキーボードの演奏に合わせてピアノ音が再生されます</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="instructions-section">
                    <div class="section-header">
                        <div class="section-icon">💡</div>
                        <h3 class="section-title">使い方</h3>
                    </div>
                    <div class="instructions-content">
                        <div class="instruction-item">
                            <span class="step-number">1</span>
                            <span class="step-text">MIDIキーボードをコンピュータに接続</span>
                        </div>
                        <div class="instruction-item">
                            <span class="step-number">2</span>
                            <span class="step-text">上記でデバイスを選択</span>
                        </div>
                        <div class="instruction-item">
                            <span class="step-number">3</span>
                            <span class="step-text">「ゲーム画面へ」ボタンを押してスタート</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-controls">
                <button id="back-to-title-btn" class="btn secondary-btn">
                    <span class="btn-icon">🏠</span>
                    <span>タイトルに戻る</span>
                </button>
                <button id="go-to-game-btn" class="btn start-btn" style="display: none;">
                    <span class="btn-icon">🎮</span>
                    <span>ゲーム画面へ</span>
                </button>
            </div>
        </div>

        <!-- ゲーム画面 -->
        <div id="game-screen" class="screen" style="display: none;">
            <div id="game-area" class="game-area">
                <div class="chord-section">
                    <div class="game-header">
                        <div class="game-icon">🎵</div>
                        <h2 class="game-title">コード練習</h2>
                        <div class="difficulty-indicator">
                            <span class="difficulty-label">レベル:</span>
                            <span class="difficulty-value">初級 - トライアド</span>
                        </div>
                    </div>
                    <div id="game-status" class="game-status">
                        <div class="status-card timer-card">
                            <div class="card-icon">⏰</div>
                            <div class="card-content">
                                <div class="card-label">残り時間</div>
                                <div class="card-value">
                                    <span id="timer" class="timer">60</span>
                                    <span class="unit">秒</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-card score-card">
                            <div class="card-icon">🎯</div>
                            <div class="card-content">
                                <div class="card-label">スコア</div>
                                <div class="card-value">
                                    <span id="score" class="score">0</span>
                                    <span class="unit">問正解</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chord-header">
                        <h3 class="chord-instruction">この和音を演奏してください</h3>
                    </div>
                    <div id="chord-display" class="chord-display">
                        <span id="current-chord">スタートを押してください</span>
                    </div>
                    <div id="result-display" class="result-display" style="display: none;">
                        <div class="result-icon">🎉</div>
                        <h3 class="result-title">ゲーム終了！</h3>
                        <div class="final-score-display">
                            <div class="score-label">最終スコア</div>
                            <div class="score-number">
                                <span id="final-score-inline">0</span>
                                <span class="score-unit">問正解</span>
                            </div>
                        </div>
                        <div class="result-message">
                            <span id="result-message-inline">お疲れさまでした！</span>
                        </div>
                    </div>
                    <div class="game-controls">
                        <button id="start-btn" class="btn game-btn start-btn">
                            <span class="btn-icon">▶️</span>
                            <span>スタート</span>
                        </button>
                        <button id="restart-btn" class="btn game-btn restart-btn" style="display: none;">
                            <span class="btn-icon">🔄</span>
                            <span>リスタート</span>
                        </button>
                        <button id="back-to-title-from-game-btn" class="btn game-btn secondary-btn">
                            <span class="btn-icon">🏠</span>
                            <span>タイトルに戻る</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="result-area" class="result-area" style="display: none;">
                <div class="result-card">
                    <div class="result-icon">🎉</div>
                    <h2 class="result-title">ゲーム終了！</h2>
                    <div class="final-score-display">
                        <div class="score-label">最終スコア</div>
                        <div class="score-number">
                            <span id="final-score">0</span>
                            <span class="score-unit">問正解</span>
                        </div>
                    </div>
                    <div class="result-message">
                        <span id="result-message">お疲れさまでした！</span>
                    </div>
                </div>
            </div>

            <div id="piano-display" class="piano-display">
                <div class="chord-info">
                    <div class="hand-info">
                        <div class="hand-item left-hand">
                            <span class="hand-icon">👈</span>
                            <span class="hand-text">左手: ルート音</span>
                        </div>
                        <div class="hand-item right-hand">
                            <span class="hand-icon">👉</span>
                            <span class="hand-text">右手: コード構成音</span>
                        </div>
                    </div>
                </div>
                <div class="piano-keyboard" id="piano-keyboard">
                    <!-- ピアノ鍵盤がここに生成されます -->
                </div>
            </div>
        </div>
    </div>

    <script>
class ChordPracticeApp {
    // バージョン情報（デプロイ時に最後の桁を増加: 0.1.0 -> 0.1.1 -> 0.1.2...）
    static VERSION = '0.1.8';
    
    constructor() {
        this.chords = [
            { name: 'C', notes: [0, 4, 7] },      // C major
            { name: 'Dm', notes: [2, 5, 9] },     // D minor
            { name: 'Em', notes: [4, 7, 11] },    // E minor
            { name: 'F', notes: [5, 9, 0] },      // F major
            { name: 'G', notes: [7, 11, 2] },     // G major
            { name: 'Am', notes: [9, 0, 4] },     // A minor
            { name: 'Bdim', notes: [11, 2, 5] }   // B diminished
        ];
        
        this.currentChord = null;
        this.gameActive = false;
        this.timeLeft = 60;
        this.score = 0;
        this.timer = null;
        this.pressedKeys = new Set();
        this.currentRange = null;
        this.justAnswered = false;
        
        this.midiAccess = null;
        this.midiInput = null;
        this.pianoKeys = {};
        this.resizeTimeout = null;
        
        // サスティーンペダル関連
        this.sustainPedalPressed = false;
        this.sustainedNotes = new Set(); // サスティーンペダルで維持される音程
        
        // MIDIメッセージハンドラーを初期化時にバインド
        this.midiMessageHandler = this.onMIDIMessage.bind(this);
        
        // オーディオコンテキストと音源の初期化
        this.audioContext = null;
        this.audioBuffers = new Map(); // プリロードされたオーディオバッファ
        this.activeSources = new Map(); // アクティブな音源
        this.masterVolume = null;
        // 設定の初期化と読み込み
        this.settings = this.loadSettings();
        
        this.initializeElements();
        this.initializeAudio();
        this.createPianoKeyboard();
        this.setupMIDI();
        this.setupEventListeners();
        
        // 設定を適用
        this.applySettings();
    }
    
    initializeElements() {
        this.elements = {
            timer: document.getElementById('timer'),
            score: document.getElementById('score'),
            currentChord: document.getElementById('current-chord'),
            startBtn: document.getElementById('start-btn'),
            restartBtn: document.getElementById('restart-btn'),
            gameArea: document.getElementById('game-area'),
            resultArea: document.getElementById('result-area'),
            finalScore: document.getElementById('final-score'),
            resultDisplay: document.getElementById('result-display'),
            finalScoreInline: document.getElementById('final-score-inline'),
            resultMessageInline: document.getElementById('result-message-inline'),
            midiMessage: document.getElementById('midi-message'),
            midiStatus: document.getElementById('midi-status'),
            chordDisplay: document.getElementById('chord-display'),
            midiDeviceSelection: document.getElementById('midi-device-selection'),
            midiDevicesSelect: document.getElementById('midi-devices'),
            pianoKeyboard: document.getElementById('piano-keyboard'),
            titleScreen: document.getElementById('title-screen'),
            settingsScreen: document.getElementById('settings-screen'),
            gameScreen: document.getElementById('game-screen'),
            gameStartBtn: document.getElementById('game-start-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            backToTitleBtn: document.getElementById('back-to-title-btn'),
            backToTitleFromGameBtn: document.getElementById('back-to-title-from-game-btn'),
            goToGameBtn: document.getElementById('go-to-game-btn'),
            statusIndicator: document.getElementById('status-indicator'),
            volumeSlider: document.getElementById('volume-slider'),
            volumeValue: document.getElementById('volume-value'),
            pedalState: document.getElementById('pedal-state'),
            versionInfo: document.getElementById('version-info')
        };
    }
    
    initializeAudio() {
        try {
            // AudioContextを作成（ユーザー操作後に初期化）
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // マスターボリュームコントロール
            this.masterVolume = this.audioContext.createGain();
            this.masterVolume.gain.setValueAtTime(this.settings.volume / 100, this.audioContext.currentTime);
            this.masterVolume.connect(this.audioContext.destination);
            
            // WAVファイルをプリロード
            this.preloadAudioFiles();
            
            console.log('Audio context initialized');
        } catch (error) {
            console.error('Failed to initialize audio context:', error);
        }
    }
    
    async preloadAudioFiles() {
        // 主要な音域のファイルを定義（3半音ごとにサンプル）
        const sampleNotes = [
            21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99, 102, 105, 108
        ];
        
        console.log('Starting to preload piano samples...');
        
        for (const midiNote of sampleNotes) {
            try {
                // ベロシティ08のファイルを基本として使用（中程度の音量）
                const fileName = this.getMIDIFileName(midiNote, 8);
                const response = await fetch(`mp3/${fileName}`);
                if (response.ok) {
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                    this.audioBuffers.set(midiNote, audioBuffer);
                    console.log(`Loaded sample for note ${midiNote}: ${fileName}`);
                } else {
                    console.warn(`Failed to load ${fileName}`);
                }
            } catch (error) {
                console.warn(`Error loading sample for note ${midiNote}:`, error);
            }
        }
        
        console.log(`Preloaded ${this.audioBuffers.size} piano samples`);
    }
    
    getMIDIFileName(midiNote, velocity = 8) {
        // MIDIノート番号からファイル名を生成
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const octave = Math.floor(midiNote / 12) - 1;
        const noteName = noteNames[midiNote % 12];
        const velocityStr = velocity.toString().padStart(2, '0');
        
        return `${midiNote.toString().padStart(3, '0')}_${noteName}${octave}v${velocityStr}.mp3`;
    }
    
    findClosestSample(midiNote) {
        // 最も近いサンプルを探す
        let closestNote = null;
        let minDistance = Infinity;
        
        for (const note of this.audioBuffers.keys()) {
            const distance = Math.abs(note - midiNote);
            if (distance < minDistance) {
                minDistance = distance;
                closestNote = note;
            }
        }
        
        return closestNote;
    }
    
    // MIDIノート番号を周波数に変換
    midiToFrequency(midiNote) {
        return 440 * Math.pow(2, (midiNote - 69) / 12);
    }
    
    // WAVサンプルでピアノ音を再生
    playNote(midiNote, velocity = 127) {
        if (!this.audioContext) return;
        
        // AudioContextが停止状態の場合、再開
        if (this.audioContext.state === 'suspended') {
            this.audioContext.resume();
        }
        
        // 既存の音を停止
        this.stopNote(midiNote);
        
        // WAVサンプルが利用可能かチェック
        const closestSample = this.findClosestSample(midiNote);
        if (closestSample) {
            const audioBuffer = this.audioBuffers.get(closestSample);
            if (audioBuffer) {
                this.playWAVSample(midiNote, velocity, closestSample, audioBuffer);
                return;
            }
        }
        
        // WAVサンプルが利用できない場合、フォールバック音源を使用
        console.log(`No WAV sample available for note ${midiNote}, using fallback tone`);
        this.playFallbackTone(midiNote, velocity);
    }
    
    playWAVSample(midiNote, velocity, closestSample, audioBuffer) {
        const now = this.audioContext.currentTime;
        
        // AudioBufferSourceNodeを作成
        const source = this.audioContext.createBufferSource();
        const gainNode = this.audioContext.createGain();
        
        source.buffer = audioBuffer;
        
        // ピッチシフト（再生レートで調整）
        const semitoneShift = midiNote - closestSample;
        const playbackRate = Math.pow(2, semitoneShift / 12);
        source.playbackRate.setValueAtTime(playbackRate, now);
        
        // ベロシティに基づく音量調整
        const volume = (velocity / 127) * 0.4;
        gainNode.gain.setValueAtTime(volume, now);
        
        // 接続
        source.connect(gainNode);
        gainNode.connect(this.masterVolume);
        
        // 再生開始
        source.start(now);
        
        // アクティブなソースとして保存
        this.activeSources.set(midiNote, { source, gainNode });
        
        console.log(`Playing piano note ${midiNote} using WAV sample ${closestSample} (pitch shift: ${semitoneShift} semitones)`);
    }
    
    playFallbackTone(midiNote, velocity) {
        const frequency = this.midiToFrequency(midiNote);
        const volume = (velocity / 127) * 0.2;
        const now = this.audioContext.currentTime;
        
        // シンプルなサイン波オシレーター
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(frequency, now);
        
        // エンベロープ
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(volume, now + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(volume * 0.3, now + 0.1);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
        
        oscillator.connect(gainNode);
        gainNode.connect(this.masterVolume);
        
        oscillator.start(now);
        oscillator.stop(now + 1.0);
        
        // アクティブなソースとして保存
        this.activeSources.set(midiNote, { source: oscillator, gainNode });
        
        console.log(`Playing fallback tone for note ${midiNote} (${frequency.toFixed(2)}Hz)`);
    }
    
    // WAVサンプルピアノ音を停止
    stopNote(midiNote) {
        const sourceData = this.activeSources.get(midiNote);
        if (sourceData) {
            const { source, gainNode } = sourceData;
            const now = this.audioContext.currentTime;
            
            try {
                // フェードアウト
                gainNode.gain.cancelScheduledValues(now);
                gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                
                // 少し遅延して音源を停止
                source.stop(now + 0.15);
            } catch (error) {
                // 既に停止している場合のエラーを無視
                console.warn(`Error stopping note ${midiNote}:`, error);
            }
            
            // マップから削除
            this.activeSources.delete(midiNote);
            
            console.log(`Stopping piano note ${midiNote}`);
        }
    }
    
    createPianoKeyboard() {
        console.log('Creating piano keyboard...');
        const keyboard = this.elements.pianoKeyboard;
        if (!keyboard) {
            console.error('Piano keyboard element not found!');
            return;
        }
        
        keyboard.innerHTML = '';
        this.pianoKeys = {};
        
        // 88鍵盤表示 (A0-C8)
        const startNote = 21; // A0
        const endNote = 108;  // C8
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // 鍵盤サイズの計算
        const container = document.querySelector('.container');
        const containerStyles = window.getComputedStyle(container);
        const containerPadding = parseFloat(containerStyles.paddingLeft) + parseFloat(containerStyles.paddingRight);
        const availableWidth = container.offsetWidth - containerPadding;
        const totalWhiteKeys = 52; // 88鍵ピアノの白鍵数
        
        // 最小鍵盤幅と理想鍵盤幅を設定
        const minWhiteKeyWidth = 8; // 最小幅を小さくして、より狭い画面でも縮小できるように
        const idealWhiteKeyWidth = Math.floor(availableWidth / totalWhiteKeys);
        const whiteKeyWidth = Math.max(minWhiteKeyWidth, idealWhiteKeyWidth);
        const blackKeyWidth = Math.floor(whiteKeyWidth * 0.6);
        
        // 縦横比を保って高さを計算（白鍵の幅:高さ = 1:6の比率、実際のピアノに近い）
        const whiteKeyHeight = Math.floor(whiteKeyWidth * 6);
        const blackKeyHeight = Math.floor(whiteKeyHeight * 0.6);
        
        console.log(`Debug: availableWidth=${availableWidth}, idealWhiteKeyWidth=${idealWhiteKeyWidth}, whiteKeyWidth=${whiteKeyWidth}`);
        
        // ブラウザの幅を変えた時のテスト用
        if (whiteKeyWidth <= 8) {
            console.log(`⚠️ Using minimum width: ${whiteKeyWidth}px (screen too narrow)`);
        } else {
            console.log(`✅ Using calculated width: ${whiteKeyWidth}px (screen wide enough)`);
        }
        
        // 各オクターブでの白鍵の配置パターン
        const whiteKeyPattern = [0, 2, 4, 5, 7, 9, 11]; // C, D, E, F, G, A, B
        const blackKeyPattern = [1, 3, 6, 8, 10]; // C#, D#, F#, G#, A#
        
        // 鍵盤全体の幅と高さを計算
        const totalKeyboardWidth = 52 * whiteKeyWidth;
        const keyboardContainer = document.createElement('div');
        keyboardContainer.style.position = 'relative';
        keyboardContainer.style.width = totalKeyboardWidth + 'px';
        keyboardContainer.style.height = whiteKeyHeight + 'px';
        
        // 親コンテナの高さも動的に設定
        keyboard.style.height = whiteKeyHeight + 'px';
        
        keyboard.appendChild(keyboardContainer);
        
        // 白鍵を配置
        let whiteKeyCount = 0;
        for (let note = startNote; note <= endNote; note++) {
            const noteIndex = note % 12;
            
            if (whiteKeyPattern.includes(noteIndex)) {
                const key = document.createElement('div');
                key.className = 'piano-key white';
                key.dataset.note = note;
                
                const noteName = noteNames[noteIndex];
                const octave = Math.floor(note / 12) - 1;
                key.textContent = `${noteName}${octave}`;
                
                // 白鍵の位置とサイズを設定
                key.style.left = (whiteKeyCount * whiteKeyWidth) + 'px';
                key.style.top = '0px';
                key.style.width = whiteKeyWidth + 'px';
                key.style.height = whiteKeyHeight + 'px';
                key.style.fontSize = Math.max(6, Math.floor(whiteKeyWidth * 0.5)) + 'px';
                
                keyboardContainer.appendChild(key);
                this.pianoKeys[note] = key;
                whiteKeyCount++;
            }
        }
        
        // 黒鍵を配置（白鍵の上に重ねる）
        for (let note = startNote; note <= endNote; note++) {
            const noteIndex = note % 12;
            
            if (blackKeyPattern.includes(noteIndex)) {
                const key = document.createElement('div');
                key.className = 'piano-key black';
                key.dataset.note = note;
                
                const noteName = noteNames[noteIndex];
                const octave = Math.floor(note / 12) - 1;
                key.textContent = `${noteName}${octave}`;
                
                // 黒鍵の位置を正確に計算
                // この音符より前にある白鍵の数を数える
                let whiteKeysBeforeThisNote = 0;
                for (let prevNote = startNote; prevNote < note; prevNote++) {
                    const prevNoteIndex = prevNote % 12;
                    if (whiteKeyPattern.includes(prevNoteIndex)) {
                        whiteKeysBeforeThisNote++;
                    }
                }
                
                // 黒鍵の位置を白鍵の境界に配置
                // 黒鍵は対応する白鍵の右端に配置される
                let leftPosition = 0;
                if (noteIndex === 1) { // C#: CとDの間
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                } else if (noteIndex === 3) { // D#: DとEの間  
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                } else if (noteIndex === 6) { // F#: FとGの間
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                } else if (noteIndex === 8) { // G#: GとAの間
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                } else if (noteIndex === 10) { // A#: AとBの間
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                }
                
                key.style.left = leftPosition + 'px';
                key.style.top = '0px';
                key.style.width = blackKeyWidth + 'px';
                key.style.height = blackKeyHeight + 'px';
                key.style.fontSize = Math.max(5, Math.floor(blackKeyWidth * 0.4)) + 'px';
                
                keyboardContainer.appendChild(key);
                this.pianoKeys[note] = key;
            }
        }
        
        console.log(`Piano keyboard created with ${Object.keys(this.pianoKeys).length} keys`);
        console.log(`Container width: ${container.offsetWidth}, Available width: ${availableWidth}, White key width: ${whiteKeyWidth}`);
        console.log(`Total keyboard width: ${totalKeyboardWidth}, Will overflow: ${totalKeyboardWidth > availableWidth}`);
    }
    
    async setupMIDI() {
        if (!navigator.requestMIDIAccess) {
            this.updateMIDIStatus('このブラウザはWeb MIDI APIに対応していません。Chrome/Edgeを使用してください。', false);
            return;
        }

        try {
            console.log('MIDI access を要求中...');
            this.midiAccess = await navigator.requestMIDIAccess();
            console.log('MIDI access 成功');
            this.midiAccess.addEventListener('statechange', () => {
                console.log('MIDI statechange event triggered');
                this.refreshMIDIDevices();
            });
            this.refreshMIDIDevices();
        } catch (error) {
            console.error('MIDI access failed:', error);
            let errorMessage = 'MIDIアクセスに失敗しました: ';
            if (error.name === 'SecurityError') {
                errorMessage += 'セキュリティエラー。HTTPSまたはlocalhostでアクセスしてください。';
            } else {
                errorMessage += error.message;
            }
            this.updateMIDIStatus(errorMessage, false);
        }
    }
    
    refreshMIDIDevices() {
        if (!this.midiAccess) return;
        
        const inputs = Array.from(this.midiAccess.inputs.values());
        console.log(`=== refreshMIDIDevices called ===`);
        console.log(`発見されたMIDIデバイス数: ${inputs.length}`);
        
        // 現在の選択を保存
        const currentSelection = this.elements.midiDevicesSelect.value;
        console.log(`現在の選択: "${currentSelection}"`);
        
        // デバイスリストをクリア
        this.elements.midiDevicesSelect.innerHTML = '<option value="">デバイスを選択してください</option>';
        
        if (inputs.length > 0) {
            this.elements.midiDeviceSelection.style.display = 'flex';
            
            inputs.forEach((input, index) => {
                console.log(`デバイス ${index + 1}: ${input.name} (ID: ${input.id})`);
                const option = document.createElement('option');
                option.value = input.id;
                option.textContent = `${input.name || 'Unknown Device'} (${input.manufacturer || 'Unknown'})`;
                this.elements.midiDevicesSelect.appendChild(option);
            });
            
            // 選択を復元（デバイスがまだ存在する場合）
            if (currentSelection && this.midiAccess.inputs.get(currentSelection)) {
                this.elements.midiDevicesSelect.value = currentSelection;
                console.log(`選択を復元: "${currentSelection}"`);
                // 既に接続されている場合はステータスを更新
                if (this.midiInput && this.midiInput.id === currentSelection) {
                    this.updateMIDIStatus(`${this.midiInput.name} に接続されました`, true);
                } else {
                    this.updateMIDIStatus(`${inputs.length}個のMIDIデバイスが見つかりました。デバイスを選択してください。`, false);
                }
            } else {
                this.updateMIDIStatus(`${inputs.length}個のMIDIデバイスが見つかりました。デバイスを選択してください。`, false);
            }
        } else {
            this.elements.midiDeviceSelection.style.display = 'none';
            this.updateMIDIStatus('MIDIデバイスが見つかりません。USB-MIDIデバイスを接続してください。', false);
        }
        
        this.updateGameButtonVisibility();
    }
    
    connectToSelectedDevice() {
        const selectedDeviceId = this.elements.midiDevicesSelect.value;
        console.log(`=== デバイス選択開始: "${selectedDeviceId}" ===`);
        console.log(`Select element value: "${this.elements.midiDevicesSelect.value}"`);
        console.log(`Select element selectedIndex: ${this.elements.midiDevicesSelect.selectedIndex}`);
        
        if (!selectedDeviceId || selectedDeviceId === "") {
            console.log('デバイスが選択されていません - 処理をスキップ');
            this.updateMIDIStatus('デバイスを選択してください', false);
            this.updateGameButtonVisibility();
            return;
        }
        
        // 既存の接続を切断
        this.disconnectMIDI();
        
        // 新しいデバイスに接続
        const selectedInput = this.midiAccess.inputs.get(selectedDeviceId);
        if (selectedInput) {
            console.log(`デバイスに接続中: ${selectedInput.name}`);
            this.midiInput = selectedInput;
            this.midiInput.addEventListener('midimessage', this.midiMessageHandler);
            this.updateMIDIStatus(`${this.midiInput.name} に接続されました`, true);
            
            // 設定を保存
            this.settings.selectedMidiDevice = selectedDeviceId;
            this.saveSettings();
            
            console.log(`=== デバイス接続完了: ${this.midiInput.name} ===`);
        } else {
            console.error(`デバイスが見つかりません: ${selectedDeviceId}`);
            this.updateMIDIStatus('選択されたデバイスに接続できませんでした', false);
        }
        
        this.updateGameButtonVisibility();
    }
    
    disconnectMIDI() {
        if (this.midiInput) {
            console.log(`MIDI切断: ${this.midiInput.name}`);
            try {
                this.midiInput.removeEventListener('midimessage', this.midiMessageHandler);
            } catch (e) {
                console.warn('イベントリスナー削除でエラー:', e);
            }
            this.midiInput = null;
        }
        
        // 押下状態をクリア
        this.pressedKeys.clear();
        this.clearPianoKeyDisplay();
    }
    
    onMIDIMessage(event) {
        const [command, note, velocity] = event.data;
        console.log(`MIDI: cmd=${command}, note=${note}, vel=${velocity}`);
        
        // Control Change (CC) メッセージの処理
        if (command === 176) {
            if (note === 64) {
                // サスティーンペダル (CC#64)
                this.handleSustainPedal(velocity >= 64);
                return;
            }
        }
        
        if (command === 144 && velocity > 0) {
            // Note ON
            this.pressedKeys.add(note);
            this.updatePianoKeyDisplay(note, true);
            this.playNote(note, velocity);
        } else if (command === 128 || (command === 144 && velocity === 0)) {
            // Note OFF
            this.pressedKeys.delete(note);
            this.handleNoteOff(note);
        }
        
        if (this.gameActive) {
            this.checkChord();
        }
    }
    
    handleSustainPedal(pressed) {
        console.log(`Sustain pedal: ${pressed ? 'ON' : 'OFF'}`);
        this.sustainPedalPressed = pressed;
        
        // UIの更新
        if (this.elements.pedalState) {
            this.elements.pedalState.textContent = pressed ? 'ON' : 'OFF';
            this.elements.pedalState.className = 'pedal-state ' + (pressed ? 'on' : 'off');
        }
        
        if (!pressed) {
            // サスティーンペダルを離した時、維持されていた音を停止
            for (const note of this.sustainedNotes) {
                if (!this.pressedKeys.has(note)) {
                    this.stopNote(note);
                    // 視覚的表示も確実にクリア（既にクリアされているはずだが念のため）
                    this.updatePianoKeyDisplay(note, false);
                }
            }
            this.sustainedNotes.clear();
        }
    }
    
    handleNoteOff(note) {
        // 鍵盤の視覚的な押下状態は常に解除
        this.updatePianoKeyDisplay(note, false);
        
        if (this.sustainPedalPressed) {
            // サスティーンペダルが押されている場合、音のみ維持
            this.sustainedNotes.add(note);
            console.log(`Note ${note} sustained by pedal (visual released)`);
        } else {
            // 通常のノートオフ処理（音も停止）
            this.stopNote(note);
        }
    }
    
    updatePianoKeyDisplay(note, pressed) {
        console.log(`Updating piano key ${note}, pressed: ${pressed}`);
        const key = this.pianoKeys[note];
        if (key) {
            if (pressed) {
                key.classList.add('pressed');
                console.log(`Key ${note} marked as pressed`);
            } else {
                key.classList.remove('pressed');
                console.log(`Key ${note} unmarked as pressed`);
            }
        } else {
            console.log(`Key ${note} not found in piano display`);
        }
    }
    
    clearPianoKeyDisplay() {
        // 全ての鍵盤から押下状態を削除
        Object.values(this.pianoKeys).forEach(key => {
            key.classList.remove('pressed');
        });
        console.log('全ての鍵盤の押下状態をクリア');
    }
    
    updateMIDIStatus(message, connected) {
        this.elements.midiMessage.textContent = message;
        this.elements.midiStatus.className = connected ? 'midi-status connected' : 'midi-status';
        
        // ステータスインジケーターも更新
        if (this.elements.statusIndicator) {
            this.elements.statusIndicator.textContent = connected ? '🟢' : '🔴';
        }
    }
    
    // 設定管理メソッド
    loadSettings() {
        const defaultSettings = {
            volume: 100,
            selectedMidiDevice: null
        };
        
        try {
            const savedSettings = localStorage.getItem('chordPracticeSettings');
            if (savedSettings) {
                return { ...defaultSettings, ...JSON.parse(savedSettings) };
            }
        } catch (error) {
            console.warn('Failed to load settings:', error);
        }
        
        return defaultSettings;
    }
    
    saveSettings() {
        try {
            localStorage.setItem('chordPracticeSettings', JSON.stringify(this.settings));
            console.log('Settings saved:', this.settings);
        } catch (error) {
            console.warn('Failed to save settings:', error);
        }
    }
    
    applySettings() {
        // 音量設定の適用
        if (this.elements.volumeSlider && this.elements.volumeValue) {
            this.elements.volumeSlider.value = this.settings.volume;
            this.elements.volumeValue.textContent = `${this.settings.volume}%`;
            this.updateVolume(this.settings.volume);
        }
        
        // MIDIデバイス設定の適用（MIDIアクセス確立後に適用）
        if (this.settings.selectedMidiDevice) {
            setTimeout(() => this.applyMidiDeviceSelection(), 1000);
        }
    }
    
    applyMidiDeviceSelection() {
        if (this.elements.midiDevicesSelect && this.settings.selectedMidiDevice) {
            // 保存されたデバイスが利用可能かチェック
            const options = Array.from(this.elements.midiDevicesSelect.options);
            const targetOption = options.find(option => option.value === this.settings.selectedMidiDevice);
            
            if (targetOption) {
                this.elements.midiDevicesSelect.value = this.settings.selectedMidiDevice;
                this.connectToSelectedDevice();
                console.log('Applied saved MIDI device:', this.settings.selectedMidiDevice);
            } else {
                console.log('Saved MIDI device no longer available:', this.settings.selectedMidiDevice);
                this.settings.selectedMidiDevice = null;
                this.saveSettings();
            }
        }
    }
    
    updateGameButtonVisibility() {
        // MIDIデバイスが接続されている場合のみ「ゲーム画面へ」ボタンを表示
        if (this.midiInput) {
            this.elements.goToGameBtn.style.display = 'inline-block';
        } else {
            this.elements.goToGameBtn.style.display = 'none';
        }
    }
    
    updateVolume(value) {
        const volume = value / 100;
        if (this.masterVolume) {
            this.masterVolume.gain.setValueAtTime(volume, this.audioContext.currentTime);
        }
        if (this.elements.volumeValue) {
            this.elements.volumeValue.textContent = `${value}%`;
        }
        
        // 設定を保存
        this.settings.volume = parseInt(value);
        this.saveSettings();
        
        console.log(`Volume updated to ${value}%`);
    }
    
    noteToString(midiNote) {
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const octave = Math.floor(midiNote / 12) - 1;
        const noteName = noteNames[midiNote % 12];
        return `${noteName}${octave}`;
    }
    
    setupEventListeners() {
        this.elements.startBtn.addEventListener('click', () => this.startGame());
        this.elements.restartBtn.addEventListener('click', () => this.restartGame());
        this.elements.midiDevicesSelect.addEventListener('change', (event) => {
            console.log(`Change event triggered, target value: "${event.target.value}"`);
            // 少し遅延させて、DOM更新の競合を避ける
            setTimeout(() => {
                this.connectToSelectedDevice();
            }, 10);
        });
        
        // 画面遷移のイベントリスナー
        this.elements.gameStartBtn.addEventListener('click', () => this.showGameScreen());
        this.elements.settingsBtn.addEventListener('click', () => this.showSettingsScreen());
        this.elements.backToTitleBtn.addEventListener('click', () => this.showTitleScreen());
        this.elements.backToTitleFromGameBtn.addEventListener('click', () => this.showTitleScreen());
        this.elements.goToGameBtn.addEventListener('click', () => this.showGameScreen());
        
        // ウィンドウリサイズイベントリスナー
        window.addEventListener('resize', () => this.handleWindowResize());
        
        // 音量コントロールのイベントリスナー
        if (this.elements.volumeSlider) {
            this.elements.volumeSlider.addEventListener('input', (event) => this.updateVolume(event.target.value));
        }
        
        // サスティーンペダルの初期状態設定
        if (this.elements.pedalState) {
            this.elements.pedalState.textContent = 'OFF';
            this.elements.pedalState.className = 'pedal-state off';
        }
        
        // バージョン情報の設定
        if (this.elements.versionInfo) {
            this.elements.versionInfo.textContent = `v${ChordPracticeApp.VERSION}`;
        }
    }
    
    handleWindowResize() {
        // ゲーム画面が表示されている場合のみ鍵盤を再作成
        if (this.elements.gameScreen.style.display === 'block') {
            // 少し遅延させて、リサイズが完了してから再計算
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
                this.createPianoKeyboard();
                this.updateRangeDisplay();
            }, 100);
        }
    }
    
    showTitleScreen() {
        this.elements.titleScreen.style.display = 'block';
        this.elements.settingsScreen.style.display = 'none';
        this.elements.gameScreen.style.display = 'none';
        
        // ゲームを停止
        if (this.gameActive) {
            this.stopGame();
        }
    }
    
    showSettingsScreen() {
        this.elements.titleScreen.style.display = 'none';
        this.elements.settingsScreen.style.display = 'block';
        this.elements.gameScreen.style.display = 'none';
        this.updateGameButtonVisibility();
    }
    
    showGameScreen() {
        // MIDIデバイスが接続されているかチェック
        if (!this.midiInput) {
            // MIDIデバイス未接続の場合は環境設定画面に遷移
            this.showSettingsScreen();
            this.updateMIDIStatus('ゲームを開始するにはMIDIデバイスを接続してください', false);
            return;
        }
        
        this.elements.titleScreen.style.display = 'none';
        this.elements.settingsScreen.style.display = 'none';
        this.elements.gameScreen.style.display = 'block';
        
        // ゲームUIの状態をリセット
        this.resetGameUI();
        
        // ゲーム画面に移行時に鍵盤を再作成して範囲を表示
        setTimeout(() => {
            this.createPianoKeyboard();
            this.generateRandomRange();
        }, 100);
    }
    
    resetGameUI() {
        // ゲームの状態をリセット
        this.gameActive = false;
        if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
        }
        
        // スコアとタイマーをリセット
        this.score = 0;
        this.timeLeft = 60;
        this.elements.score.textContent = this.score;
        this.elements.timer.textContent = this.timeLeft;
        
        // ボタンの表示状態をリセット
        this.elements.startBtn.style.display = 'inline-block';
        this.elements.restartBtn.style.display = 'none';
        
        // UIの表示状態をリセット
        this.elements.resultDisplay.style.display = 'none';
        this.elements.chordDisplay.style.display = 'block';
        this.elements.currentChord.textContent = 'スタートを押してください';
        
        // 結果エリアも非表示にする
        this.elements.resultArea.style.display = 'none';
    }
    
    startGame() {
        this.gameActive = true;
        this.score = 0;
        this.timeLeft = 60;
        
        this.elements.startBtn.style.display = 'none';
        this.elements.restartBtn.style.display = 'inline-block';
        this.elements.resultArea.style.display = 'none';
        
        // インライン結果表示を隠して和音表示を表示
        this.elements.resultDisplay.style.display = 'none';
        this.elements.chordDisplay.style.display = 'block';
        
        this.generateRandomRange();
        this.nextChord();
        this.startTimer();
    }
    
    restartGame() {
        this.stopGame();
        this.startGame();
    }
    
    stopGame() {
        this.gameActive = false;
        if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
        }
        
        this.elements.startBtn.style.display = 'inline-block';
        this.elements.restartBtn.style.display = 'none';
        
        // 和音表示を隠してインライン結果表示を表示
        this.elements.chordDisplay.style.display = 'none';
        this.elements.resultDisplay.style.display = 'block';
        this.elements.finalScoreInline.textContent = this.score;
        
        // 結果メッセージを設定
        let message = 'お疲れさまでした！';
        if (this.score >= 15) {
            message = '素晴らしい！完璧な演奏です！';
        } else if (this.score >= 10) {
            message = 'とても良い演奏でした！';
        } else if (this.score >= 5) {
            message = '良い調子です！';
        }
        this.elements.resultMessageInline.textContent = message;
    }
    
    startTimer() {
        this.updateTimer();
        this.timer = setInterval(() => {
            this.timeLeft--;
            this.updateTimer();
            
            if (this.timeLeft <= 0) {
                this.stopGame();
            }
        }, 1000);
    }
    
    updateTimer() {
        this.elements.timer.textContent = this.timeLeft;
    }
    
    generateRandomRange() {
        // 固定範囲: 左手C2-C3、右手C4-C5
        this.currentRange = {
            leftHandMin: 36,  // C2
            leftHandMax: 48,  // C3
            rightHandMin: 60, // C4
            rightHandMax: 72  // C5
        };
        
        this.updateRangeDisplay();
    }
    
    updateRangeDisplay() {
        // 前の範囲表示をクリア
        Object.values(this.pianoKeys).forEach(key => {
            key.classList.remove('left-hand-range', 'right-hand-range');
        });
        
        if (!this.currentRange) return;
        
        // 左手範囲を青色で表示（白鍵のみ）
        for (let note = this.currentRange.leftHandMin; note <= this.currentRange.leftHandMax; note++) {
            const key = this.pianoKeys[note];
            if (key && key.classList.contains('white')) {
                key.classList.add('left-hand-range');
            }
        }
        
        // 右手範囲を緑色で表示（白鍵のみ）
        for (let note = this.currentRange.rightHandMin; note <= this.currentRange.rightHandMax; note++) {
            const key = this.pianoKeys[note];
            if (key && key.classList.contains('white')) {
                key.classList.add('right-hand-range');
            }
        }
    }
    
    nextChord() {
        this.currentChord = this.chords[Math.floor(Math.random() * this.chords.length)];
        this.elements.currentChord.textContent = this.currentChord.name;
        // 正解フラグをリセット（連続正解防止）
        this.justAnswered = true;
        setTimeout(() => {
            this.justAnswered = false;
        }, 200);
    }
    
    checkChord() {
        if (this.pressedKeys.size === 0 || this.justAnswered) return;
        
        const pressedNotes = Array.from(this.pressedKeys);
        const leftHandNotes = pressedNotes.filter(note => 
            note >= this.currentRange.leftHandMin && note <= this.currentRange.leftHandMax
        );
        const rightHandNotes = pressedNotes.filter(note => 
            note >= this.currentRange.rightHandMin && note <= this.currentRange.rightHandMax
        );
        
        if (leftHandNotes.length === 0 || rightHandNotes.length === 0) return;
        
        const leftHandNote = leftHandNotes[0] % 12;
        const rightHandNotesMod = rightHandNotes.map(note => note % 12);
        
        const chordRoot = this.currentChord.notes[0];
        const chordNotes = new Set(this.currentChord.notes);
        
        if (leftHandNote === chordRoot && 
            rightHandNotesMod.length === 3 && 
            rightHandNotesMod.every(note => chordNotes.has(note)) &&
            new Set(rightHandNotesMod).size === 3) {
            
            this.correctAnswer();
        }
    }
    
    playCorrectAnswerSound() {
        if (!this.currentChord) return;
        
        // 現在のコードの音程を取得
        const chordNotes = this.currentChord.notes;
        const velocity = 80; // 少し大きめの音量で演奏
        
        // 左手（ルート音）を演奏 - C3オクターブ
        const rootNoteNumber = 48 + chordNotes[0]; // C3 = 48
        this.playNote(rootNoteNumber, velocity);
        
        // 右手（コード構成音）を100ms後に演奏 - C5オクターブ  
        setTimeout(() => {
            chordNotes.forEach((note, index) => {
                const noteNumber = 72 + note; // C5 = 72
                this.playNote(noteNumber, velocity);
            });
        }, 100);
        
        // 演奏を1秒後に停止
        setTimeout(() => {
            // ルート音を停止
            this.stopNote(rootNoteNumber);
            // コード構成音を停止
            chordNotes.forEach((note) => {
                const noteNumber = 72 + note;
                this.stopNote(noteNumber);
            });
        }, 1000);
    }
    
    correctAnswer() {
        this.score++;
        this.elements.score.textContent = this.score;
        
        // 正解音を自動演奏
        this.playCorrectAnswerSound();
        
        this.elements.chordDisplay.classList.add('correct');
        setTimeout(() => {
            this.elements.chordDisplay.classList.remove('correct');
        }, 500);
        
        // 正解後すぐに次のコードに移行し、連続正解を防ぐ
        this.nextChord();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new ChordPracticeApp();
});
    </script>
</body>
</html>