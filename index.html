<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Practice App</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.container {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    width: 95%;
    max-width: 1400px;
    text-align: center;
}

h1 {
    color: #4a5568;
    margin-bottom: 30px;
    font-size: 2.5em;
    font-weight: 300;
}

h2 {
    color: #4a5568;
    margin-bottom: 20px;
    font-size: 2em;
    font-weight: 400;
}

.game-status {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
    padding: 20px;
    background: #f7fafc;
    border-radius: 10px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.label {
    font-weight: bold;
    color: #4a5568;
}

.timer {
    font-size: 2em;
    font-weight: bold;
    color: #e53e3e;
    min-width: 60px;
}

.score {
    font-size: 2em;
    font-weight: bold;
    color: #38a169;
    min-width: 40px;
}

.unit {
    color: #718096;
}


.controls {
    display: flex;
    justify-content: center;
    gap: 20px;
}

.btn {
    padding: 15px 30px;
    font-size: 1.2em;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 150px;
}

.start-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.start-btn:hover {
    background: linear-gradient(135deg, #38a169, #2f855a);
    transform: translateY(-2px);
}

.restart-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.restart-btn:hover {
    background: linear-gradient(135deg, #3182ce, #2c5282);
    transform: translateY(-2px);
}



.midi-device-selection {
    margin-bottom: 20px;
    padding: 15px;
    background: #f7fafc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    justify-content: center;
}

.device-label {
    font-weight: bold;
    color: #4a5568;
}

.device-select {
    padding: 8px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    background: white;
    color: #4a5568;
    font-size: 1em;
    min-width: 250px;
}

.device-select:focus {
    outline: none;
    border-color: #4299e1;
}

.piano-display {
    margin: 20px 0;
    padding: 0;
    background: transparent;
}

.piano-keyboard {
    position: relative;
    background: transparent;
    width: 100%;
    margin: 0;
    overflow-x: visible;
    display: flex;
    justify-content: center;
}

.piano-key {
    position: absolute;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    font-weight: bold;
    transition: all 0.1s ease;
    border-radius: 0 0 5px 5px;
}

.piano-key.white {
    background: white;
    border: 1px solid #ddd;
    z-index: 1;
    color: #666;
    padding-bottom: 3px;
}

.piano-key.black {
    background: #1a1a1a;
    border: 1px solid #000;
    z-index: 2;
    color: #ccc;
    padding-bottom: 2px;
    border-radius: 0 0 3px 3px;
}

.piano-key.pressed {
    background: #4299e1 !important;
    color: white !important;
    transform: scale(0.95);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

.piano-key.white.left-hand-range.pressed,
.piano-key.white.right-hand-range.pressed {
    background: #4299e1 !important;
    color: white !important;
}

.piano-key.correct {
    background: #48bb78 !important;
    color: white !important;
}

.piano-key.incorrect {
    background: #f56565 !important;
    color: white !important;
}

.piano-key.white.left-hand-range {
    background: rgba(66, 153, 225, 0.3) !important;
}

.piano-key.white.right-hand-range {
    background: rgba(72, 187, 120, 0.3) !important;
}

.screen {
    display: block;
}

.title-header {
    text-align: center;
    margin-bottom: 60px;
}

.music-icon {
    font-size: 4em;
    margin-bottom: 20px;
    animation: bounce 2s ease-in-out infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

.main-title {
    font-size: 3.5em;
    font-weight: bold;
    margin-bottom: 10px;
    color: #4a5568; /* fallback color */
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
}

/* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
@media (max-width: 768px) {
    .main-title {
        font-size: 2.8em;
    }
    
    .music-icon {
        font-size: 3em;
    }
    
    .title-btn {
        width: 240px;
        font-size: 1.2em;
        padding: 18px 25px;
    }
    
    .subtitle {
        font-size: 1.1em;
    }
}

.subtitle {
    font-size: 1.2em;
    color: #718096;
    margin: 0;
    font-weight: normal;
}

.title-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin: 40px 0;
}

.title-btn {
    width: 280px;
    padding: 20px 30px;
    font-size: 1.3em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.title-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.btn-icon {
    font-size: 1.2em;
}

.title-footer {
    margin-top: 40px;
    text-align: center;
}

.description {
    color: #718096;
    font-size: 1em;
    margin: 0;
    font-style: italic;
}

.version-info {
    color: #a0aec0;
    font-size: 0.8em;
    margin: 8px 0 0 0;
    font-family: 'Courier New', monospace;
    opacity: 0.7;
}

.secondary-btn {
    background: linear-gradient(135deg, #718096, #4a5568);
    color: white;
}

.secondary-btn:hover {
    background: linear-gradient(135deg, #4a5568, #2d3748);
    transform: translateY(-2px);
}

.settings-header {
    text-align: center;
    margin-bottom: 40px;
}

.settings-icon {
    font-size: 3em;
    margin-bottom: 15px;
}

.settings-title {
    font-size: 2.2em;
    font-weight: bold;
    margin-bottom: 8px;
    color: #4a5568;
}

.settings-subtitle {
    font-size: 1.1em;
    color: #718096;
    margin: 0;
}

.settings-content {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-bottom: 40px;
}

.midi-section, .audio-section, .instructions-section {
    background: #f8fafc;
    border-radius: 15px;
    padding: 25px;
    border: 1px solid #e2e8f0;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.section-icon {
    font-size: 1.5em;
}

.section-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #4a5568;
    margin: 0;
}

.midi-status {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    background: #fed7d7;
    border: 1px solid #feb2b2;
}

.midi-status.connected {
    background: #c6f6d5;
    border: 1px solid #9ae6b4;
}

.status-icon {
    font-size: 1.2em;
}

.status-content {
    flex: 1;
    font-weight: 500;
    color: #2d3748;
}

.device-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    color: #4a5568;
    margin-bottom: 10px;
    font-size: 1em;
}

.label-icon {
    font-size: 1.1em;
}

.device-select-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
}

.device-select {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    color: #4a5568;
    font-size: 1em;
    appearance: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.device-select:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.select-arrow {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #718096;
    pointer-events: none;
    font-size: 0.8em;
}

.instructions-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.instruction-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px 0;
}

.step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    font-size: 0.9em;
}

.step-text {
    color: #4a5568;
    font-size: 1em;
}

.audio-controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.volume-control {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.volume-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    color: #4a5568;
    font-size: 1em;
}

.volume-slider-wrapper {
    display: flex;
    align-items: center;
    gap: 15px;
}

.volume-slider {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: #e2e8f0;
    outline: none;
    -webkit-appearance: none;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.volume-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.volume-value {
    min-width: 40px;
    font-weight: bold;
    color: #4a5568;
    font-size: 0.9em;
}

.sustain-pedal-indicator {
    background: white;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #e2e8f0;
}

.pedal-status {
    display: flex;
    align-items: center;
    gap: 10px;
}

.pedal-icon {
    font-size: 1.2em;
}

.pedal-label {
    font-weight: bold;
    color: #4a5568;
}

.pedal-state {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.8em;
    min-width: 40px;
    text-align: center;
}

.pedal-state.off {
    background: #fed7d7;
    color: #c53030;
}

.pedal-state.on {
    background: #c6f6d5;
    color: #2d7d32;
}

.audio-info {
    background: white;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #e2e8f0;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.info-icon {
    font-size: 1.1em;
}

.info-text {
    color: #4a5568;
    font-size: 0.9em;
    line-height: 1.4;
}

.settings-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 30px;
}

/* „Ç≤„Éº„É†ÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
.game-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
}

.game-icon {
    font-size: 2em;
}

.game-title {
    font-size: 1.8em;
    font-weight: bold;
    margin: 0;
    color: #4a5568;
}

.difficulty-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
    color: #718096;
    margin-left: auto;
}

.difficulty-label {
    font-weight: 500;
}

.difficulty-value {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 0.85em;
}

.game-status-container {
    margin-bottom: 30px;
}

.game-status {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 25px;
    padding: 0;
    background: transparent;
    border-radius: 0;
}

.status-card {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 12px;
    padding: 15px 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    max-width: 200px;
}

.timer-card {
    border-left: 4px solid #e53e3e;
}

.score-card {
    border-left: 4px solid #38a169;
}

.card-icon {
    font-size: 1.8em;
}

.card-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.card-label {
    font-size: 0.9em;
    font-weight: 500;
    color: #718096;
}

.card-value {
    display: flex;
    align-items: baseline;
    gap: 5px;
}

.timer {
    font-size: 1.8em;
    font-weight: bold;
    color: #e53e3e;
}

.score {
    font-size: 1.8em;
    font-weight: bold;
    color: #38a169;
}

.unit {
    font-size: 0.9em;
    color: #718096;
    font-weight: normal;
}

.chord-section {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}

.chord-header {
    text-align: center;
    margin-bottom: 25px;
}

.chord-instruction {
    font-size: 1.2em;
    color: #4a5568;
    margin: 0;
    font-weight: 500;
}

.chord-display {
    text-align: center;
    padding: 35px 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 15px;
    border: 2px solid #e2e8f0;
    margin-bottom: 25px;
    transition: all 0.3s ease;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
    position: relative;
}

.correct-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 150px;
    height: 150px;
    background: transparent;
    border: 8px solid #e53e3e;
    border-radius: 50%;
    animation: correctPulse 0.6s ease-out;
    box-shadow: 0 4px 20px rgba(229, 62, 62, 0.4);
    z-index: 15;
}

@keyframes correctPulse {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
    50% {
        transform: translate(-50%, -50%) scale(1.15);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
}

.countdown-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 120px;
    height: 120px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    z-index: 10;
}

.countdown-display span {
    font-size: 4em;
    font-weight: bold;
    color: white;
    animation: countdownPulse 1s ease-in-out;
}

@keyframes countdownPulse {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    50% {
        transform: scale(1.2);
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.result-display {
    text-align: center;
    padding: 30px 20px;
    background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
    border-radius: 15px;
    border: 2px solid #38a169;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(56, 161, 105, 0.15);
}

.result-display .result-icon {
    font-size: 2.5em;
    margin-bottom: 15px;
}

.result-display .result-title {
    font-size: 1.5em;
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 20px;
}

.result-display .final-score-display {
    margin-bottom: 15px;
}

.result-display .score-label {
    font-size: 1em;
    color: #4a5568;
    margin-bottom: 8px;
}

.result-display .score-number {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 8px;
}

.result-display .score-number span:first-child {
    font-size: 2.5em;
    font-weight: bold;
    color: #38a169;
}

.result-display .score-unit {
    font-size: 1.2em;
    color: #4a5568;
}

.result-display .result-message {
    color: #4a5568;
    font-size: 1.1em;
}

#current-chord {
    font-size: 4em;
    font-weight: bold;
    color: #2d3748;
}

.chord-info {
    margin-bottom: 15px;
}

.hand-info {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.hand-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 12px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e2e8f0;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    font-size: 1em;
    font-weight: 600;
    transition: all 0.2s ease;
    min-width: 160px;
}

.hand-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.left-hand {
    border: 2px solid #3182ce;
    background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
    color: #2c5282;
}

.left-hand .hand-icon {
    background: #3182ce;
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
}

.right-hand {
    border: 2px solid #38a169;
    background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
    color: #276749;
}

.right-hand .hand-icon {
    background: #38a169;
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
}


.hand-text {
    font-weight: 600;
    flex: 1;
}

.game-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
}

.game-btn {
    min-width: 140px;
    padding: 15px 25px;
    font-size: 1.1em;
}

.result-area {
    background: transparent;
    padding: 0;
    border-radius: 0;
    margin-bottom: 30px;
}

.result-card {
    background: white;
    border-radius: 20px;
    padding: 40px 30px;
    text-align: center;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
}

.result-icon {
    font-size: 3em;
    margin-bottom: 15px;
}

.result-title {
    font-size: 2em;
    font-weight: bold;
    color: #4a5568;
    margin-bottom: 25px;
}

.final-score-display {
    margin-bottom: 20px;
}

.score-label {
    font-size: 1.1em;
    color: #718096;
    margin-bottom: 10px;
}

.score-number {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 8px;
}

.score-number #final-score {
    font-size: 3em;
    font-weight: bold;
    color: #38a169;
}

.score-unit {
    font-size: 1.2em;
    color: #718096;
}

.result-message {
    color: #4a5568;
    font-size: 1.1em;
}

.piano-display {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 20px;
    padding: 25px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}

@media (max-width: 768px) {
    .settings-content {
        gap: 20px;
    }
    
    .midi-section, .instructions-section {
        padding: 20px;
    }
    
    .settings-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .settings-controls .btn {
        width: 240px;
    }
    
    .game-status {
        flex-direction: column;
        align-items: center;
    }
    
    .status-card {
        width: 100%;
        max-width: 280px;
    }
    
    .hand-info {
        flex-direction: column;
        gap: 15px;
    }
    
    .hand-item {
        justify-content: center;
    }
    
    .game-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .game-btn {
        width: 200px;
    }
    
    #current-chord {
        font-size: 3em;
    }
}

@keyframes correct {
    0% { background: #c6f6d5; }
    100% { background: #f7fafc; }
}

@keyframes incorrect {
    0% { background: #fed7d7; }
    100% { background: #f7fafc; }
}

.chord-display.correct {
    animation: correct 0.5s ease;
}

.chord-display.incorrect {
    animation: incorrect 0.5s ease;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
        <div id="title-screen" class="screen">
            <div class="title-header">
                <div class="music-icon">üéπ</div>
                <h1 class="main-title">Chord Master</h1>
                <p class="subtitle">„Éî„Ç¢„Éé„Ç≥„Éº„ÉâÁ∑¥Áøí„Ç¢„Éó„É™</p>
            </div>
            <div class="title-controls">
                <button id="game-start-btn" class="btn title-btn start-btn">
                    <span class="btn-icon">üéµ</span>
                    <span>„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</span>
                </button>
                <button id="settings-btn" class="btn title-btn secondary-btn">
                    <span class="btn-icon">‚öôÔ∏è</span>
                    <span>Áí∞Â¢ÉË®≠ÂÆö</span>
                </button>
            </div>
            <div class="title-footer">
                <p class="description">MIDI„Ç≠„Éº„Éú„Éº„Éâ„Åß„Ç≥„Éº„Éâ„ÇíÊºîÂ•è„Åó„Å¶Á∑¥Áøí„Åó„Çà„ÅÜ</p>
                <p class="version-info" id="version-info">v0.1.0</p>
            </div>
        </div>

        <!-- Áí∞Â¢ÉË®≠ÂÆöÁîªÈù¢ -->
        <div id="settings-screen" class="screen" style="display: none;">
            <div class="settings-header">
                <div class="settings-icon">‚öôÔ∏è</div>
                <h2 class="settings-title">Áí∞Â¢ÉË®≠ÂÆö</h2>
                <p class="settings-subtitle">MIDI„Ç≠„Éº„Éú„Éº„Éâ„ÅÆÊé•Á∂öË®≠ÂÆö</p>
            </div>

            <div class="settings-content">
                <div class="midi-section">
                    <div class="section-header">
                        <div class="section-icon">üéπ</div>
                        <h3 class="section-title">MIDI„Éá„Éê„Ç§„Çπ</h3>
                    </div>
                    
                    <div id="midi-status" class="midi-status">
                        <div class="status-icon">
                            <span id="status-indicator">üî¥</span>
                        </div>
                        <div class="status-content">
                            <span id="midi-message">MIDI„Éá„Éê„Ç§„Çπ„ÇíÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                        </div>
                    </div>

                    <div id="midi-device-selection" class="midi-device-selection" style="display: none;">
                        <label for="midi-devices" class="device-label">
                            <span class="label-icon">üéº</span>
                            MIDI„Éá„Éê„Ç§„ÇπÈÅ∏Êäû
                        </label>
                        <div class="device-select-wrapper">
                            <select id="midi-devices" class="device-select">
                                <option value="">„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                            <div class="select-arrow">‚ñº</div>
                        </div>
                    </div>
                </div>

                <div class="audio-section">
                    <div class="section-header">
                        <div class="section-icon">üîä</div>
                        <h3 class="section-title">„Ç™„Éº„Éá„Ç£„Ç™Ë®≠ÂÆö</h3>
                    </div>
                    
                    <div class="audio-controls">
                        <div class="volume-control">
                            <label for="volume-slider" class="volume-label">
                                <span class="label-icon">üéöÔ∏è</span>
                                „Éî„Ç¢„ÉéÈü≥Èáè
                            </label>
                            <div class="volume-slider-wrapper">
                                <input type="range" id="volume-slider" class="volume-slider" 
                                       min="0" max="100" value="100" step="1">
                                <span id="volume-value" class="volume-value">100%</span>
                            </div>
                        </div>
                        <div class="sustain-pedal-indicator">
                            <div class="pedal-status" id="sustain-pedal-status">
                                <span class="pedal-icon">ü¶∂</span>
                                <span class="pedal-label">„Çµ„Çπ„ÉÜ„Ç£„Éº„É≥„Éö„ÉÄ„É´</span>
                                <span class="pedal-state" id="pedal-state">OFF</span>
                            </div>
                        </div>
                        <div class="audio-info">
                            <div class="info-item">
                                <span class="info-icon">‚ÑπÔ∏è</span>
                                <span class="info-text">MIDI„Ç≠„Éº„Éú„Éº„Éâ„ÅÆÊºîÂ•è„Å´Âêà„Çè„Åõ„Å¶„Éî„Ç¢„ÉéÈü≥„ÅåÂÜçÁîü„Åï„Çå„Åæ„Åô</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="instructions-section">
                    <div class="section-header">
                        <div class="section-icon">üí°</div>
                        <h3 class="section-title">‰Ωø„ÅÑÊñπ</h3>
                    </div>
                    <div class="instructions-content">
                        <div class="instruction-item">
                            <span class="step-number">1</span>
                            <span class="step-text">MIDI„Ç≠„Éº„Éú„Éº„Éâ„Çí„Ç≥„É≥„Éî„É•„Éº„Çø„Å´Êé•Á∂ö</span>
                        </div>
                        <div class="instruction-item">
                            <span class="step-number">2</span>
                            <span class="step-text">‰∏äË®ò„Åß„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû</span>
                        </div>
                        <div class="instruction-item">
                            <span class="step-number">3</span>
                            <span class="step-text">„Äå„Ç≤„Éº„É†ÁîªÈù¢„Å∏„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Çπ„Çø„Éº„Éà</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-controls">
                <button id="back-to-title-btn" class="btn secondary-btn">
                    <span class="btn-icon">üè†</span>
                    <span>„Çø„Ç§„Éà„É´„Å´Êàª„Çã</span>
                </button>
                <button id="go-to-game-btn" class="btn start-btn" style="display: none;">
                    <span class="btn-icon">üéÆ</span>
                    <span>„Ç≤„Éº„É†ÁîªÈù¢„Å∏</span>
                </button>
            </div>
        </div>

        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="game-screen" class="screen" style="display: none;">
            <div id="game-area" class="game-area">
                <div class="chord-section">
                    <div class="game-header">
                        <div class="game-icon">üéµ</div>
                        <h2 class="game-title">„Ç≥„Éº„ÉâÁ∑¥Áøí</h2>
                        <div class="difficulty-indicator">
                            <span class="difficulty-label">„É¨„Éô„É´:</span>
                            <span class="difficulty-value">ÂàùÁ¥ö - „Éà„É©„Ç§„Ç¢„Éâ</span>
                        </div>
                    </div>
                    <div id="game-status" class="game-status">
                        <div class="status-card timer-card">
                            <div class="card-icon">‚è∞</div>
                            <div class="card-content">
                                <div class="card-label">ÊÆã„ÇäÊôÇÈñì</div>
                                <div class="card-value">
                                    <span id="timer" class="timer">60</span>
                                    <span class="unit">Áßí</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-card score-card">
                            <div class="card-icon">üéØ</div>
                            <div class="card-content">
                                <div class="card-label">„Çπ„Ç≥„Ç¢</div>
                                <div class="card-value">
                                    <span id="score" class="score">0</span>
                                    <span class="unit">ÂïèÊ≠£Ëß£</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chord-header">
                        <h3 class="chord-instruction" style="display: none;">„Åì„ÅÆÂíåÈü≥„ÇíÊºîÂ•è„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                    </div>
                    <div id="chord-display" class="chord-display">
                        <span id="current-chord">„Çπ„Çø„Éº„Éà„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                        <div id="correct-indicator" class="correct-indicator" style="display: none;"></div>
                        <div id="countdown-display" class="countdown-display" style="display: none;">
                            <span id="countdown-number">3</span>
                        </div>
                    </div>
                    <div id="result-display" class="result-display" style="display: none;">
                        <div class="result-icon">üéâ</div>
                        <h3 class="result-title">„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</h3>
                        <div class="final-score-display">
                            <div class="score-label">ÊúÄÁµÇ„Çπ„Ç≥„Ç¢</div>
                            <div class="score-number">
                                <span id="final-score-inline">0</span>
                                <span class="score-unit">ÂïèÊ≠£Ëß£</span>
                            </div>
                        </div>
                        <div class="result-message">
                            <span id="result-message-inline">„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ</span>
                        </div>
                    </div>
                    <div class="game-controls">
                        <button id="start-btn" class="btn game-btn start-btn">
                            <span class="btn-icon">‚ñ∂Ô∏è</span>
                            <span>„Çπ„Çø„Éº„Éà</span>
                        </button>
                        <button id="restart-btn" class="btn game-btn restart-btn" style="display: none;">
                            <span class="btn-icon">üîÑ</span>
                            <span>„É™„Çπ„Çø„Éº„Éà</span>
                        </button>
                        <button id="back-to-title-from-game-btn" class="btn game-btn secondary-btn">
                            <span class="btn-icon">üè†</span>
                            <span>„Çø„Ç§„Éà„É´„Å´Êàª„Çã</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="result-area" class="result-area" style="display: none;">
                <div class="result-card">
                    <div class="result-icon">üéâ</div>
                    <h2 class="result-title">„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</h2>
                    <div class="final-score-display">
                        <div class="score-label">ÊúÄÁµÇ„Çπ„Ç≥„Ç¢</div>
                        <div class="score-number">
                            <span id="final-score">0</span>
                            <span class="score-unit">ÂïèÊ≠£Ëß£</span>
                        </div>
                    </div>
                    <div class="result-message">
                        <span id="result-message">„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ</span>
                    </div>
                </div>
            </div>

            <div id="piano-display" class="piano-display">
                <div class="chord-info">
                    <div class="hand-info">
                        <div class="hand-item left-hand">
                            <span class="hand-icon">üëà</span>
                            <span class="hand-text">Â∑¶Êâã: „É´„Éº„ÉàÈü≥</span>
                        </div>
                        <div class="hand-item right-hand">
                            <span class="hand-icon">üëâ</span>
                            <span class="hand-text">Âè≥Êâã: „Ç≥„Éº„ÉâÊßãÊàêÈü≥</span>
                        </div>
                    </div>
                </div>
                <div class="piano-keyboard" id="piano-keyboard">
                    <!-- „Éî„Ç¢„ÉéÈçµÁõ§„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
                </div>
            </div>
        </div>
    </div>

    <script>
class ChordPracticeApp {
    // „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±Ôºà„Éá„Éó„É≠„Ç§ÊôÇ„Å´ÊúÄÂæå„ÅÆÊ°Å„ÇíÂ¢óÂä†: 0.1.0 -> 0.1.1 -> 0.1.2...Ôºâ
    static VERSION = '0.1.31';
    
    constructor() {
        this.chords = [
            { name: 'C', notes: [0, 4, 7] },      // C major
            { name: 'Dm', notes: [2, 5, 9] },     // D minor
            { name: 'Em', notes: [4, 7, 11] },    // E minor
            { name: 'F', notes: [5, 9, 0] },      // F major
            { name: 'G', notes: [7, 11, 2] },     // G major
            { name: 'Am', notes: [9, 0, 4] },     // A minor
            { name: 'Bdim', notes: [11, 2, 5] }   // B diminished
        ];
        
        this.currentChord = null;
        this.gameActive = false;
        this.timeLeft = 60;
        this.score = 0;
        this.timer = null;
        this.pressedKeys = new Set();
        this.currentRange = null;
        this.justAnswered = false;
        
        this.midiAccess = null;
        this.midiInput = null;
        this.pianoKeys = {};
        this.resizeTimeout = null;
        
        // „Çµ„Çπ„ÉÜ„Ç£„Éº„É≥„Éö„ÉÄ„É´Èñ¢ÈÄ£
        this.sustainPedalPressed = false;
        this.sustainedNotes = new Set(); // „Çµ„Çπ„ÉÜ„Ç£„Éº„É≥„Éö„ÉÄ„É´„ÅßÁ∂≠ÊåÅ„Åï„Çå„ÇãÈü≥Á®ã
        
        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Áä∂ÊÖãÁÆ°ÁêÜ
        this.countdownInterval = null;
        
        // Ê≠£Ëß£Âæå„ÅÆÂæÖÊ©üÁä∂ÊÖãÁÆ°ÁêÜ
        this.waitingForNextQuestion = false;
        
        // MIDI„É°„ÉÉ„Çª„Éº„Ç∏„Éè„É≥„Éâ„É©„Éº„ÇíÂàùÊúüÂåñÊôÇ„Å´„Éê„Ç§„É≥„Éâ
        this.midiMessageHandler = this.onMIDIMessage.bind(this);
        
        // „Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Å®Èü≥Ê∫ê„ÅÆÂàùÊúüÂåñ
        this.audioContext = null;
        this.audioBuffers = new Map(); // „Éó„É™„É≠„Éº„Éâ„Åï„Çå„Åü„Ç™„Éº„Éá„Ç£„Ç™„Éê„ÉÉ„Éï„Ç°
        this.activeSources = new Map(); // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Èü≥Ê∫ê
        this.masterVolume = null;
        // Ë®≠ÂÆö„ÅÆÂàùÊúüÂåñ„Å®Ë™≠„ÅøËæº„Åø
        this.settings = this.loadSettings();
        
        this.initializeElements();
        this.initializeAudio();
        this.createPianoKeyboard();
        this.setupMIDI();
        this.setupEventListeners();
        
        // Ë®≠ÂÆö„ÇíÈÅ©Áî®
        this.applySettings();
    }
    
    initializeElements() {
        this.elements = {
            timer: document.getElementById('timer'),
            score: document.getElementById('score'),
            currentChord: document.getElementById('current-chord'),
            correctIndicator: document.getElementById('correct-indicator'),
            countdownDisplay: document.getElementById('countdown-display'),
            countdownNumber: document.getElementById('countdown-number'),
            startBtn: document.getElementById('start-btn'),
            restartBtn: document.getElementById('restart-btn'),
            gameArea: document.getElementById('game-area'),
            resultArea: document.getElementById('result-area'),
            finalScore: document.getElementById('final-score'),
            resultDisplay: document.getElementById('result-display'),
            finalScoreInline: document.getElementById('final-score-inline'),
            resultMessageInline: document.getElementById('result-message-inline'),
            midiMessage: document.getElementById('midi-message'),
            midiStatus: document.getElementById('midi-status'),
            chordDisplay: document.getElementById('chord-display'),
            midiDeviceSelection: document.getElementById('midi-device-selection'),
            midiDevicesSelect: document.getElementById('midi-devices'),
            pianoKeyboard: document.getElementById('piano-keyboard'),
            titleScreen: document.getElementById('title-screen'),
            settingsScreen: document.getElementById('settings-screen'),
            gameScreen: document.getElementById('game-screen'),
            gameStartBtn: document.getElementById('game-start-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            backToTitleBtn: document.getElementById('back-to-title-btn'),
            backToTitleFromGameBtn: document.getElementById('back-to-title-from-game-btn'),
            goToGameBtn: document.getElementById('go-to-game-btn'),
            statusIndicator: document.getElementById('status-indicator'),
            volumeSlider: document.getElementById('volume-slider'),
            volumeValue: document.getElementById('volume-value'),
            pedalState: document.getElementById('pedal-state'),
            versionInfo: document.getElementById('version-info'),
            chordInstruction: document.querySelector('.chord-instruction')
        };
    }
    
    initializeAudio() {
        try {
            // AudioContext„Çí‰ΩúÊàêÔºà„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂæå„Å´ÂàùÊúüÂåñÔºâ
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // „É™„Éü„ÉÉ„Çø„Éº„Å®„Ç≥„É≥„Éó„É¨„ÉÉ„Çµ„Éº„Çí‰ΩúÊàê
            this.createLimiter();
            
            // „Éû„Çπ„Çø„Éº„Éú„É™„É•„Éº„É†„Ç≥„É≥„Éà„É≠„Éº„É´
            this.masterVolume = this.audioContext.createGain();
            this.masterVolume.gain.setValueAtTime((this.settings.volume / 100) * 3, this.audioContext.currentTime);
            this.masterVolume.connect(this.compressor);
            
            // WAV„Éï„Ç°„Ç§„É´„Çí„Éó„É™„É≠„Éº„Éâ
            this.preloadAudioFiles();
            
            console.log('Audio context initialized with limiter');
        } catch (error) {
            console.error('Failed to initialize audio context:', error);
        }
    }
    
    createLimiter() {
        // -0.5dB„Åß„É™„Éü„ÉÉ„Çø„Éº„Çí‰ΩúÊàê
        const limitThreshold = Math.pow(10, -0.5 / 20); // -0.5dB = Á¥Ñ0.944„ÅÆÊåØÂπÖ
        
        // „Ç≥„É≥„Éó„É¨„ÉÉ„Çµ„Éº„Åß„ÇΩ„Éï„Éà„É™„Éü„ÉÉ„ÉÜ„Ç£„É≥„Ç∞
        this.compressor = this.audioContext.createDynamicsCompressor();
        this.compressor.threshold.setValueAtTime(-3, this.audioContext.currentTime); // -3dB threshold
        this.compressor.knee.setValueAtTime(0, this.audioContext.currentTime); // Hard knee
        this.compressor.ratio.setValueAtTime(20, this.audioContext.currentTime); // High ratio for limiting
        this.compressor.attack.setValueAtTime(0.001, this.audioContext.currentTime); // Fast attack
        this.compressor.release.setValueAtTime(0.1, this.audioContext.currentTime); // Quick release
        
        // „Éè„Éº„Éâ„É™„Éü„ÉÉ„Çø„ÉºÔºàWaveShaperÔºâ
        this.limiter = this.audioContext.createWaveShaper();
        this.limiter.curve = this.createLimiterCurve(limitThreshold);
        this.limiter.oversample = '4x';
        
        // „É™„Éê„Éº„Éñ„Çí‰ΩúÊàê
        this.createReverb();
        
        // Êé•Á∂ö: compressor -> reverb -> limiter -> destination
        this.compressor.connect(this.reverbSend);
        this.compressor.connect(this.limiter); // „Éâ„É©„Ç§„Ç∑„Ç∞„Éä„É´
        this.reverbReturn.connect(this.limiter); // „Ç¶„Çß„ÉÉ„Éà„Ç∑„Ç∞„Éä„É´
        this.limiter.connect(this.audioContext.destination);
        
        console.log(`Audio chain created: compressor -> reverb -> limiter -> destination`);
        console.log(`Limiter threshold: ${limitThreshold.toFixed(3)} (-0.5dB)`);
    }
    
    createLimiterCurve(threshold) {
        // WaveShaperÁî®„ÅÆ„Ç´„Éº„Éñ„Çí‰ΩúÊàê
        const samples = 65536;
        const curve = new Float32Array(samples);
        
        for (let i = 0; i < samples; i++) {
            const x = (i * 2) / samples - 1; // -1 to 1„ÅÆÁØÑÂõ≤
            const absX = Math.abs(x);
            
            if (absX <= threshold) {
                // „Åó„Åç„ÅÑÂÄ§‰ª•‰∏ã„ÅØ„Åù„ÅÆ„Åæ„Åæ
                curve[i] = x;
            } else {
                // „Åó„Åç„ÅÑÂÄ§‰ª•‰∏ä„ÅØ„Éè„Éº„Éâ„É™„Éü„ÉÉ„Éà
                curve[i] = Math.sign(x) * threshold;
            }
        }
        
        return curve;
    }
    
    createReverb() {
        // „Ç≥„É≥„Éú„É™„É•„Éº„Ç∑„Éß„É≥„É™„Éê„Éº„ÉñÁî®„ÅÆ„Ç§„É≥„Éë„É´„Çπ„É¨„Çπ„Éù„É≥„Çπ„Çí‰ΩúÊàê
        const sampleRate = this.audioContext.sampleRate;
        const length = sampleRate * 2.0; // 2Áßí„ÅÆ„É™„Éê„Éº„Éñ
        const impulse = this.audioContext.createBuffer(2, length, sampleRate);
        
        // „É´„Éº„É†„É™„Éê„Éº„Éñ„ÅÆ„Ç§„É≥„Éë„É´„Çπ„É¨„Çπ„Éù„É≥„Çπ„ÇíÁîüÊàê
        for (let channel = 0; channel < 2; channel++) {
            const channelData = impulse.getChannelData(channel);
            for (let i = 0; i < length; i++) {
                const n = length - i;
                // ÊåáÊï∞Èñ¢Êï∞ÁöÑ„Å´Ê∏õË°∞„Åô„Çã„Éé„Ç§„Ç∫Ôºà„É´„Éº„É†ÁâπÊÄß„Çí„Ç∑„Éü„É•„É¨„Éº„ÉàÔºâ
                const decay = Math.pow(n / length, 2.5); // Ê∏õË°∞„Ç´„Éº„Éñ
                const earlyReflection = i < sampleRate * 0.05 ? Math.random() * 0.3 : 0; // ÂàùÊúüÂèçÂ∞Ñ
                const lateReverb = (Math.random() * 2 - 1) * decay * 0.15; // ÂæåÊúüÊÆãÈüø
                channelData[i] = (earlyReflection + lateReverb) * (1 - channel * 0.1); // „Çπ„ÉÜ„É¨„Ç™Â∑Æ
            }
        }
        
        // „Ç≥„É≥„Éú„É™„É•„Éº„Ç∑„Éß„É≥„É™„Éê„Éº„Éñ„Çí‰ΩúÊàê
        this.reverb = this.audioContext.createConvolver();
        this.reverb.buffer = impulse;
        
        // „É™„Éê„Éº„Éñ„Çª„É≥„ÉâÔºà„Ç¶„Çß„ÉÉ„Éà‰ø°Âè∑Áî®Ôºâ
        this.reverbSend = this.audioContext.createGain();
        this.reverbSend.gain.setValueAtTime(0.12, this.audioContext.currentTime); // 12%„ÅÆÊéß„Åà„ÇÅ„Å™„É™„Éê„Éº„Éñ
        
        // „É™„Éê„Éº„Éñ„É™„Çø„Éº„É≥
        this.reverbReturn = this.audioContext.createGain();
        this.reverbReturn.gain.setValueAtTime(1.0, this.audioContext.currentTime);
        
        // Êé•Á∂ö: reverbSend -> reverb -> reverbReturn
        this.reverbSend.connect(this.reverb);
        this.reverb.connect(this.reverbReturn);
        
        console.log('Room reverb created (2.0s decay, 12% wet)');
    }
    
    async preloadAudioFiles() {
        // ‰∏ªË¶Å„Å™Èü≥Âüü„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂÆöÁæ©Ôºà3ÂçäÈü≥„Åî„Å®„Å´„Çµ„É≥„Éó„É´Ôºâ
        const sampleNotes = [
            21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99, 102, 105, 108
        ];
        
        console.log('Starting to preload piano samples...');
        
        // Âü∫Êú¨ÁöÑ„Å™„Éô„É≠„Ç∑„ÉÜ„Ç£„É¨„Ç§„É§„Éº„Çí„Éó„É™„É≠„Éº„ÉâÔºàÈü≥„ÅåÂá∫„Å™„ÅÑÂïèÈ°å„ÇíÈò≤„ÅêÔºâ
        const essentialLayers = [4, 8, 12]; // ËªΩ„ÅÑ„ÄÅ‰∏≠Á®ãÂ∫¶„ÄÅÂº∑„ÅÑÊâìÈçµ
        
        for (const midiNote of sampleNotes) {
            for (const velocityLayer of essentialLayers) {
                try {
                    const fileName = this.getMIDIFileName(midiNote, velocityLayer);
                    const response = await fetch(`mp3/${fileName}`);
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                        // Êñ∞„Åó„ÅÑ„Ç≠„ÉºÂΩ¢Âºè„Åß‰øùÂ≠ò
                        const velocityKey = `${midiNote}_v${velocityLayer.toString().padStart(2, '0')}`;
                        this.audioBuffers.set(velocityKey, audioBuffer);
                        
                        // „Éô„É≠„Ç∑„ÉÜ„Ç£„É¨„Ç§„É§„Éº8„ÅØÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÂè§„ÅÑ„Ç≠„Éº„Åß„ÇÇ‰øùÂ≠ò
                        if (velocityLayer === 8) {
                            this.audioBuffers.set(midiNote, audioBuffer);
                        }
                        
                        console.log(`Loaded velocity layer ${velocityLayer} for note ${midiNote}: ${fileName}`);
                    } else {
                        console.warn(`Failed to load ${fileName}`);
                    }
                } catch (error) {
                    console.warn(`Error loading sample for note ${midiNote}, layer ${velocityLayer}:`, error);
                }
            }
        }
        
        console.log(`Preloaded ${this.audioBuffers.size} piano samples`);
    }
    
    async loadSingleAudioFile(filePath) {
        try {
            const response = await fetch(filePath);
            if (response.ok) {
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                this.audioBuffers.set(filePath, audioBuffer);
                console.log(`Loaded audio file: ${filePath}`);
            } else {
                console.warn(`Failed to load ${filePath}`);
            }
        } catch (error) {
            console.warn(`Error loading audio file ${filePath}:`, error);
            throw error;
        }
    }
    
    getMIDIFileName(midiNote, velocity = 8) {
        // MIDI„Éé„Éº„ÉàÁï™Âè∑„Åã„Çâ„Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàê
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const octave = Math.floor(midiNote / 12) - 1;
        const noteName = noteNames[midiNote % 12];
        const velocityStr = velocity.toString().padStart(2, '0');
        
        // #ÊñáÂ≠ó„ÇíURL„Ç®„É≥„Ç≥„Éº„Éâ„Åó„Å¶Ê≠£„Åó„ÅÑ„Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàê
        const encodedNoteName = encodeURIComponent(noteName);
        return `${midiNote.toString().padStart(3, '0')}_${encodedNoteName}${octave}v${velocityStr}.mp3`;
    }
    
    findClosestSample(midiNote) {
        // ÊúÄ„ÇÇËøë„ÅÑ„Çµ„É≥„Éó„É´„ÇíÊé¢„Åô
        let closestNote = null;
        let minDistance = Infinity;
        
        for (const note of this.audioBuffers.keys()) {
            const distance = Math.abs(note - midiNote);
            if (distance < minDistance) {
                minDistance = distance;
                closestNote = note;
            }
        }
        
        return closestNote;
    }
    
    // MIDI„Éé„Éº„ÉàÁï™Âè∑„ÇíÂë®Ê≥¢Êï∞„Å´Â§âÊèõ
    midiToFrequency(midiNote) {
        return 440 * Math.pow(2, (midiNote - 69) / 12);
    }
    
    // „Éô„É≠„Ç∑„ÉÜ„Ç£„Åã„ÇâÈÅ©Âàá„Å™„É¨„Ç§„É§„ÉºÁï™Âè∑„ÇíË®àÁÆóÔºàÁõ¥Á∑öÁöÑ„Éû„ÉÉ„Éî„É≥„Ç∞Ôºâ
    getVelocityLayer(velocity) {
        // 30-110„ÅÆ„Éô„É≠„Ç∑„ÉÜ„Ç£„Çí1-16„ÅÆ„É¨„Ç§„É§„Éº„Å´Áõ¥Á∑öÁöÑ„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
        const minVel = 30;
        const maxVel = 110;
        const clampedVel = Math.max(minVel, Math.min(maxVel, velocity));
        
        // 30-110„Çí 1-16„Å´„Éû„ÉÉ„Éî„É≥„Ç∞ÔºàÁõ¥Á∑öÁöÑÔºâ
        const normalizedVel = (clampedVel - minVel) / (maxVel - minVel); // 0-1„Å´Ê≠£Ë¶èÂåñ
        const layer = Math.floor(normalizedVel * 15) + 1; // 1-16„ÅÆ„É¨„Ç§„É§„Éº
        return Math.max(1, Math.min(16, layer));
    }
    
    // WAV„Çµ„É≥„Éó„É´„Åß„Éî„Ç¢„ÉéÈü≥„ÇíÂÜçÁîü
    playNote(midiNote, velocity = 127) {
        if (!this.audioContext) return;
        
        // AudioContext„ÅåÂÅúÊ≠¢Áä∂ÊÖã„ÅÆÂ†¥Âêà„ÄÅÂÜçÈñã
        if (this.audioContext.state === 'suspended') {
            this.audioContext.resume();
        }
        
        // Êó¢Â≠ò„ÅÆÈü≥„ÇíÂÅúÊ≠¢
        this.stopNote(midiNote);
        
        // ÈÅ©Âàá„Å™„Çµ„É≥„Éó„É´„ÇíÊé¢„Åô
        const closestSample = this.findClosestSample(midiNote);
        if (closestSample) {
            // „Åæ„Åö„Éô„Éº„Ç∑„ÉÉ„ÇØ„Çµ„É≥„Éó„É´Ôºàv08Ôºâ„ÅßÂç≥Â∫ß„Å´ÂÜçÁîü
            let audioBuffer = this.audioBuffers.get(closestSample);
            if (audioBuffer) {
                this.playWAVSample(midiNote, velocity, closestSample, audioBuffer, 8);
                
                // ËÉåÊôØ„ÅßÈÅ©Âàá„Å™„Éô„É≠„Ç∑„ÉÜ„Ç£„É¨„Ç§„É§„Éº„Çí„É≠„Éº„Éâ„Åó„Å¶Ê¨°Âõû„Å´ÂÇô„Åà„Çã
                const velocityLayer = this.getVelocityLayer(velocity);
                if (velocityLayer !== 8) {
                    this.preloadVelocityLayerInBackground(closestSample, velocityLayer);
                }
                return;
            }
        }
        
        // WAV„Çµ„É≥„Éó„É´„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈü≥Ê∫ê„Çí‰ΩøÁî®
        console.log(`No WAV sample available for note ${midiNote}, using fallback tone`);
        this.playFallbackTone(midiNote, velocity);
    }
    
    // ËÉåÊôØ„Åß„Éô„É≠„Ç∑„ÉÜ„Ç£„É¨„Ç§„É§„Éº„Çí„Éó„É™„É≠„Éº„ÉâÔºàÈùûÂêåÊúüÔºâ
    preloadVelocityLayerInBackground(midiNote, velocityLayer) {
        const velocityKey = `${midiNote}_v${velocityLayer.toString().padStart(2, '0')}`;
        if (this.audioBuffers.has(velocityKey)) {
            return; // Êó¢„Å´„É≠„Éº„ÉâÊ∏à„Åø
        }
        
        const fileName = this.getMIDIFileName(midiNote, velocityLayer);
        this.loadVelocityLayer(midiNote, velocityLayer, fileName).catch(error => {
            console.warn(`Background preload failed for velocity layer ${velocityLayer}:`, error);
        });
    }
    
    async loadVelocityLayer(midiNote, velocityLayer, fileName) {
        try {
            const response = await fetch(`mp3/${fileName}`);
            if (response.ok) {
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                const velocityKey = `${midiNote}_v${velocityLayer.toString().padStart(2, '0')}`;
                this.audioBuffers.set(velocityKey, audioBuffer);
                console.log(`Loaded velocity layer ${velocityLayer} for note ${midiNote}: ${fileName}`);
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.warn(`Error loading velocity layer: ${error}`);
            throw error;
        }
    }
    
    playWAVSample(midiNote, velocity, closestSample, audioBuffer, velocityLayer = 8) {
        const now = this.audioContext.currentTime;
        
        // AudioBufferSourceNode„Çí‰ΩúÊàê
        const source = this.audioContext.createBufferSource();
        const gainNode = this.audioContext.createGain();
        
        source.buffer = audioBuffer;
        
        // „Éî„ÉÉ„ÉÅ„Ç∑„Éï„ÉàÔºàÂÜçÁîü„É¨„Éº„Éà„ÅßË™øÊï¥Ôºâ
        const semitoneShift = midiNote - closestSample;
        const playbackRate = Math.pow(2, semitoneShift / 12);
        source.playbackRate.setValueAtTime(playbackRate, now);
        
        // „Éô„É≠„Ç∑„ÉÜ„Ç£„Å´Âü∫„Å•„ÅèÈü≥ÈáèË™øÊï¥Ôºà„ÉÄ„Éñ„É´„ÉÄ„Ç§„Éä„Éü„ÇØ„ÇπÔºâ
        // „Éô„É≠„Ç∑„ÉÜ„Ç£„É¨„Ç§„É§„Éº„Å®Èü≥Èáè„ÅÆ‰∏°Êñπ„Åß„ÉÄ„Ç§„Éä„Éü„ÇØ„Çπ„ÇíË°®Áèæ
        const minVel = 30;
        const maxVel = 110;
        const clampedVel = Math.max(minVel, Math.min(maxVel, velocity));
        
        // 30-110„ÅÆÁØÑÂõ≤„ÅßÈü≥Èáè„ÇíË™øÊï¥ÔºàÂÖ®‰ΩìÈü≥Èáè„Åå300%„ÇíË∂ä„Åà„Å™„ÅÑ„Çà„ÅÜ„Å´Ë™øÊï¥Ôºâ
        const normalizedVel = (clampedVel - minVel) / (maxVel - minVel);
        const volume = 0.12 + (normalizedVel * 0.28); // ÊúÄÂ∞è12%„Åã„ÇâÊúÄÂ§ß40%„Åæ„ÅßÔºà300%„ÅÆ3ÂÄç„Éû„Çπ„Çø„Éº„Å®ÁµÑ„ÅøÂêà„Çè„Åõ„Å¶ÊúÄÂ§ß120%Ôºâ
        gainNode.gain.setValueAtTime(volume, now);
        
        // Êé•Á∂ö
        source.connect(gainNode);
        gainNode.connect(this.masterVolume);
        
        // ÂÜçÁîüÈñãÂßã
        source.start(now);
        
        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÇΩ„Éº„Çπ„Å®„Åó„Å¶‰øùÂ≠ò
        this.activeSources.set(midiNote, { source, gainNode });
        
        console.log(`Playing piano note ${midiNote} using velocity layer ${velocityLayer} (vel:${velocity}/127, vol:${(volume*100).toFixed(0)}%) sample ${closestSample}`);
    }
    
    playFallbackTone(midiNote, velocity) {
        const frequency = this.midiToFrequency(midiNote);
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈü≥Ê∫ê„Åß„ÇÇ30-110„ÅÆÁØÑÂõ≤„Åß„ÉÄ„Ç§„Éä„Éü„ÇØ„Çπ„ÇíÈÅ©Áî®
        const minVel = 30;
        const maxVel = 110;
        const clampedVel = Math.max(minVel, Math.min(maxVel, velocity));
        const normalizedVel = (clampedVel - minVel) / (maxVel - minVel);
        const volume = (0.06 + (normalizedVel * 0.14)) * 0.2; // 0.012-0.04„ÅÆÁØÑÂõ≤ÔºàÂÖ®‰ΩìÈü≥Èáè„ÇíÊäë„Åà„ÇãÔºâ
        const now = this.audioContext.currentTime;
        
        // „Ç∑„É≥„Éó„É´„Å™„Çµ„Ç§„É≥Ê≥¢„Ç™„Ç∑„É¨„Éº„Çø„Éº
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(frequency, now);
        
        // „Ç®„É≥„Éô„É≠„Éº„Éó
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(volume, now + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(volume * 0.3, now + 0.1);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
        
        oscillator.connect(gainNode);
        gainNode.connect(this.masterVolume);
        
        oscillator.start(now);
        oscillator.stop(now + 1.0);
        
        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÇΩ„Éº„Çπ„Å®„Åó„Å¶‰øùÂ≠ò
        this.activeSources.set(midiNote, { source: oscillator, gainNode });
        
        console.log(`Playing fallback tone for note ${midiNote} (${frequency.toFixed(2)}Hz)`);
    }
    
    // WAV„Çµ„É≥„Éó„É´„Éî„Ç¢„ÉéÈü≥„ÇíÂÅúÊ≠¢
    stopNote(midiNote) {
        const sourceData = this.activeSources.get(midiNote);
        if (sourceData) {
            const { source, gainNode } = sourceData;
            const now = this.audioContext.currentTime;
            
            try {
                // „Çà„ÇäÁü≠„ÅÑÊ∏õË°∞ÊôÇÈñì„ÅßËá™ÁÑ∂„Å™„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
                gainNode.gain.cancelScheduledValues(now);
                gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3); // 0.3Áßí„Åß„Éï„Çß„Éº„Éâ
                
                // „É™„Éê„Éº„Éñ„ÉÜ„Éº„É´„ÇíËÄÉÊÖÆ„Åó„Å¶ÈÅÖÂª∂ÂÅúÊ≠¢
                source.stop(now + 0.5);
            } catch (error) {
                // Êó¢„Å´ÂÅúÊ≠¢„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Ç®„É©„Éº„ÇíÁÑ°Ë¶ñ
                console.warn(`Error stopping note ${midiNote}:`, error);
            }
            
            // „Éû„ÉÉ„Éó„Åã„ÇâÂâäÈô§
            this.activeSources.delete(midiNote);
            
            console.log(`Stopping piano note ${midiNote} with natural decay`);
        }
    }
    
    createPianoKeyboard() {
        console.log('Creating piano keyboard...');
        const keyboard = this.elements.pianoKeyboard;
        if (!keyboard) {
            console.error('Piano keyboard element not found!');
            return;
        }
        
        keyboard.innerHTML = '';
        this.pianoKeys = {};
        
        // 88ÈçµÁõ§Ë°®Á§∫ (A0-C8)
        const startNote = 21; // A0
        const endNote = 108;  // C8
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // ÈçµÁõ§„Çµ„Ç§„Ç∫„ÅÆË®àÁÆó
        const container = document.querySelector('.container');
        const containerStyles = window.getComputedStyle(container);
        const containerPadding = parseFloat(containerStyles.paddingLeft) + parseFloat(containerStyles.paddingRight);
        const availableWidth = container.offsetWidth - containerPadding;
        const totalWhiteKeys = 52; // 88Èçµ„Éî„Ç¢„Éé„ÅÆÁôΩÈçµÊï∞
        
        // ÊúÄÂ∞èÈçµÁõ§ÂπÖ„Å®ÁêÜÊÉ≥ÈçµÁõ§ÂπÖ„ÇíË®≠ÂÆö
        const minWhiteKeyWidth = 8; // ÊúÄÂ∞èÂπÖ„ÇíÂ∞è„Åï„Åè„Åó„Å¶„ÄÅ„Çà„ÇäÁã≠„ÅÑÁîªÈù¢„Åß„ÇÇÁ∏ÆÂ∞è„Åß„Åç„Çã„Çà„ÅÜ„Å´
        const idealWhiteKeyWidth = Math.floor(availableWidth / totalWhiteKeys);
        const whiteKeyWidth = Math.max(minWhiteKeyWidth, idealWhiteKeyWidth);
        const blackKeyWidth = Math.floor(whiteKeyWidth * 0.6);
        
        // Á∏¶Ê®™ÊØî„Çí‰øù„Å£„Å¶È´ò„Åï„ÇíË®àÁÆóÔºàÁôΩÈçµ„ÅÆÂπÖ:È´ò„Åï = 1:6„ÅÆÊØîÁéá„ÄÅÂÆüÈöõ„ÅÆ„Éî„Ç¢„Éé„Å´Ëøë„ÅÑÔºâ
        const whiteKeyHeight = Math.floor(whiteKeyWidth * 6);
        const blackKeyHeight = Math.floor(whiteKeyHeight * 0.6);
        
        console.log(`Debug: availableWidth=${availableWidth}, idealWhiteKeyWidth=${idealWhiteKeyWidth}, whiteKeyWidth=${whiteKeyWidth}`);
        
        // „Éñ„É©„Ç¶„Ç∂„ÅÆÂπÖ„ÇíÂ§â„Åà„ÅüÊôÇ„ÅÆ„ÉÜ„Çπ„ÉàÁî®
        if (whiteKeyWidth <= 8) {
            console.log(`‚ö†Ô∏è Using minimum width: ${whiteKeyWidth}px (screen too narrow)`);
        } else {
            console.log(`‚úÖ Using calculated width: ${whiteKeyWidth}px (screen wide enough)`);
        }
        
        // ÂêÑ„Ç™„ÇØ„Çø„Éº„Éñ„Åß„ÅÆÁôΩÈçµ„ÅÆÈÖçÁΩÆ„Éë„Çø„Éº„É≥
        const whiteKeyPattern = [0, 2, 4, 5, 7, 9, 11]; // C, D, E, F, G, A, B
        const blackKeyPattern = [1, 3, 6, 8, 10]; // C#, D#, F#, G#, A#
        
        // ÈçµÁõ§ÂÖ®‰Ωì„ÅÆÂπÖ„Å®È´ò„Åï„ÇíË®àÁÆó
        const totalKeyboardWidth = 52 * whiteKeyWidth;
        const keyboardContainer = document.createElement('div');
        keyboardContainer.style.position = 'relative';
        keyboardContainer.style.width = totalKeyboardWidth + 'px';
        keyboardContainer.style.height = whiteKeyHeight + 'px';
        
        // Ë¶™„Ç≥„É≥„ÉÜ„Éä„ÅÆÈ´ò„Åï„ÇÇÂãïÁöÑ„Å´Ë®≠ÂÆö
        keyboard.style.height = whiteKeyHeight + 'px';
        
        keyboard.appendChild(keyboardContainer);
        
        // ÁôΩÈçµ„ÇíÈÖçÁΩÆ
        let whiteKeyCount = 0;
        for (let note = startNote; note <= endNote; note++) {
            const noteIndex = note % 12;
            
            if (whiteKeyPattern.includes(noteIndex)) {
                const key = document.createElement('div');
                key.className = 'piano-key white';
                key.dataset.note = note;
                
                const noteName = noteNames[noteIndex];
                const octave = Math.floor(note / 12) - 1;
                key.textContent = `${noteName}${octave}`;
                
                // ÁôΩÈçµ„ÅÆ‰ΩçÁΩÆ„Å®„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
                key.style.left = (whiteKeyCount * whiteKeyWidth) + 'px';
                key.style.top = '0px';
                key.style.width = whiteKeyWidth + 'px';
                key.style.height = whiteKeyHeight + 'px';
                key.style.fontSize = Math.max(6, Math.floor(whiteKeyWidth * 0.5)) + 'px';
                
                keyboardContainer.appendChild(key);
                this.pianoKeys[note] = key;
                whiteKeyCount++;
            }
        }
        
        // ÈªíÈçµ„ÇíÈÖçÁΩÆÔºàÁôΩÈçµ„ÅÆ‰∏ä„Å´Èáç„Å≠„ÇãÔºâ
        for (let note = startNote; note <= endNote; note++) {
            const noteIndex = note % 12;
            
            if (blackKeyPattern.includes(noteIndex)) {
                const key = document.createElement('div');
                key.className = 'piano-key black';
                key.dataset.note = note;
                
                // ÈªíÈçµ„Å´„ÅØÈü≥Âêç„ÇíË°®Á§∫„Åó„Å™„ÅÑ
                
                // ÈªíÈçµ„ÅÆ‰ΩçÁΩÆ„ÇíÊ≠£Á¢∫„Å´Ë®àÁÆó
                // „Åì„ÅÆÈü≥Á¨¶„Çà„ÇäÂâç„Å´„ÅÇ„ÇãÁôΩÈçµ„ÅÆÊï∞„ÇíÊï∞„Åà„Çã
                let whiteKeysBeforeThisNote = 0;
                for (let prevNote = startNote; prevNote < note; prevNote++) {
                    const prevNoteIndex = prevNote % 12;
                    if (whiteKeyPattern.includes(prevNoteIndex)) {
                        whiteKeysBeforeThisNote++;
                    }
                }
                
                // ÈªíÈçµ„ÅÆ‰ΩçÁΩÆ„ÇíÁôΩÈçµ„ÅÆÂ¢ÉÁïå„Å´ÈÖçÁΩÆ
                // ÈªíÈçµ„ÅØÂØæÂøú„Åô„ÇãÁôΩÈçµ„ÅÆÂè≥Á´Ø„Å´ÈÖçÁΩÆ„Åï„Çå„Çã
                let leftPosition = 0;
                if (noteIndex === 1) { // C#: C„Å®D„ÅÆÈñì
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                } else if (noteIndex === 3) { // D#: D„Å®E„ÅÆÈñì  
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                } else if (noteIndex === 6) { // F#: F„Å®G„ÅÆÈñì
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                } else if (noteIndex === 8) { // G#: G„Å®A„ÅÆÈñì
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                } else if (noteIndex === 10) { // A#: A„Å®B„ÅÆÈñì
                    leftPosition = whiteKeysBeforeThisNote * whiteKeyWidth - (blackKeyWidth / 2);
                }
                
                key.style.left = leftPosition + 'px';
                key.style.top = '0px';
                key.style.width = blackKeyWidth + 'px';
                key.style.height = blackKeyHeight + 'px';
                key.style.fontSize = Math.max(5, Math.floor(blackKeyWidth * 0.4)) + 'px';
                
                keyboardContainer.appendChild(key);
                this.pianoKeys[note] = key;
            }
        }
        
        console.log(`Piano keyboard created with ${Object.keys(this.pianoKeys).length} keys`);
        console.log(`Container width: ${container.offsetWidth}, Available width: ${availableWidth}, White key width: ${whiteKeyWidth}`);
        console.log(`Total keyboard width: ${totalKeyboardWidth}, Will overflow: ${totalKeyboardWidth > availableWidth}`);
    }
    
    async setupMIDI() {
        if (!navigator.requestMIDIAccess) {
            this.updateMIDIStatus('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØWeb MIDI API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome/Edge„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', false);
            return;
        }

        try {
            console.log('MIDI access „ÇíË¶ÅÊ±Ç‰∏≠...');
            this.midiAccess = await navigator.requestMIDIAccess();
            console.log('MIDI access ÊàêÂäü');
            this.midiAccess.addEventListener('statechange', () => {
                console.log('MIDI statechange event triggered');
                this.refreshMIDIDevices();
            });
            this.refreshMIDIDevices();
        } catch (error) {
            console.error('MIDI access failed:', error);
            let errorMessage = 'MIDI„Ç¢„ÇØ„Çª„Çπ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ';
            if (error.name === 'SecurityError') {
                errorMessage += '„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç®„É©„Éº„ÄÇHTTPS„Åæ„Åü„ÅØlocalhost„Åß„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
            } else {
                errorMessage += error.message;
            }
            this.updateMIDIStatus(errorMessage, false);
        }
    }
    
    refreshMIDIDevices() {
        if (!this.midiAccess) return;
        
        const inputs = Array.from(this.midiAccess.inputs.values());
        console.log(`=== refreshMIDIDevices called ===`);
        console.log(`Áô∫Ë¶ã„Åï„Çå„ÅüMIDI„Éá„Éê„Ç§„ÇπÊï∞: ${inputs.length}`);
        
        // ÁèæÂú®„ÅÆÈÅ∏Êäû„Çí‰øùÂ≠ò
        const currentSelection = this.elements.midiDevicesSelect.value;
        console.log(`ÁèæÂú®„ÅÆÈÅ∏Êäû: "${currentSelection}"`);
        
        // „Éá„Éê„Ç§„Çπ„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
        this.elements.midiDevicesSelect.innerHTML = '<option value="">„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
        
        if (inputs.length > 0) {
            this.elements.midiDeviceSelection.style.display = 'flex';
            
            inputs.forEach((input, index) => {
                console.log(`„Éá„Éê„Ç§„Çπ ${index + 1}: ${input.name} (ID: ${input.id})`);
                const option = document.createElement('option');
                option.value = input.id;
                option.textContent = `${input.name || 'Unknown Device'} (${input.manufacturer || 'Unknown'})`;
                this.elements.midiDevicesSelect.appendChild(option);
            });
            
            // ÈÅ∏Êäû„ÇíÂæ©ÂÖÉÔºà„Éá„Éê„Ç§„Çπ„Åå„Åæ„Å†Â≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
            if (currentSelection && this.midiAccess.inputs.get(currentSelection)) {
                this.elements.midiDevicesSelect.value = currentSelection;
                console.log(`ÈÅ∏Êäû„ÇíÂæ©ÂÖÉ: "${currentSelection}"`);
                // Êó¢„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                if (this.midiInput && this.midiInput.id === currentSelection) {
                    this.updateMIDIStatus(`${this.midiInput.name} „Å´Êé•Á∂ö„Åï„Çå„Åæ„Åó„Åü`, true);
                } else {
                    this.updateMIDIStatus(`${inputs.length}ÂÄã„ÅÆMIDI„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, false);
                }
            } else {
                this.updateMIDIStatus(`${inputs.length}ÂÄã„ÅÆMIDI„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, false);
            }
        } else {
            this.elements.midiDeviceSelection.style.display = 'none';
            this.updateMIDIStatus('MIDI„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇUSB-MIDI„Éá„Éê„Ç§„Çπ„ÇíÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', false);
        }
        
        this.updateGameButtonVisibility();
    }
    
    connectToSelectedDevice() {
        const selectedDeviceId = this.elements.midiDevicesSelect.value;
        console.log(`=== „Éá„Éê„Ç§„ÇπÈÅ∏ÊäûÈñãÂßã: "${selectedDeviceId}" ===`);
        console.log(`Select element value: "${this.elements.midiDevicesSelect.value}"`);
        console.log(`Select element selectedIndex: ${this.elements.midiDevicesSelect.selectedIndex}`);
        
        if (!selectedDeviceId || selectedDeviceId === "") {
            console.log('„Éá„Éê„Ç§„Çπ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì - Âá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó');
            this.updateMIDIStatus('„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', false);
            this.updateGameButtonVisibility();
            return;
        }
        
        // Êó¢Â≠ò„ÅÆÊé•Á∂ö„ÇíÂàáÊñ≠
        this.disconnectMIDI();
        
        // Êñ∞„Åó„ÅÑ„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö
        const selectedInput = this.midiAccess.inputs.get(selectedDeviceId);
        if (selectedInput) {
            console.log(`„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö‰∏≠: ${selectedInput.name}`);
            this.midiInput = selectedInput;
            this.midiInput.addEventListener('midimessage', this.midiMessageHandler);
            this.updateMIDIStatus(`${this.midiInput.name} „Å´Êé•Á∂ö„Åï„Çå„Åæ„Åó„Åü`, true);
            
            // Ë®≠ÂÆö„Çí‰øùÂ≠ò
            this.settings.selectedMidiDevice = selectedDeviceId;
            this.saveSettings();
            
            console.log(`=== „Éá„Éê„Ç§„ÇπÊé•Á∂öÂÆå‰∫Ü: ${this.midiInput.name} ===`);
        } else {
            console.error(`„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${selectedDeviceId}`);
            this.updateMIDIStatus('ÈÅ∏Êäû„Åï„Çå„Åü„Éá„Éê„Ç§„Çπ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü', false);
        }
        
        this.updateGameButtonVisibility();
    }
    
    disconnectMIDI() {
        if (this.midiInput) {
            console.log(`MIDIÂàáÊñ≠: ${this.midiInput.name}`);
            try {
                this.midiInput.removeEventListener('midimessage', this.midiMessageHandler);
            } catch (e) {
                console.warn('„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂâäÈô§„Åß„Ç®„É©„Éº:', e);
            }
            this.midiInput = null;
        }
        
        // Êäº‰∏ãÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
        this.pressedKeys.clear();
        this.clearPianoKeyDisplay();
    }
    
    onMIDIMessage(event) {
        const [command, note, velocity] = event.data;
        console.log(`MIDI: cmd=${command}, note=${note}, vel=${velocity}`);
        
        // Control Change (CC) „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂá¶ÁêÜ
        if (command === 176) {
            if (note === 64) {
                // „Çµ„Çπ„ÉÜ„Ç£„Éº„É≥„Éö„ÉÄ„É´ (CC#64)
                this.handleSustainPedal(velocity >= 64);
                return;
            }
        }
        
        if (command === 144 && velocity > 0) {
            // Note ON
            this.pressedKeys.add(note);
            this.updatePianoKeyDisplay(note, true);
            this.playNote(note, velocity);
        } else if (command === 128 || (command === 144 && velocity === 0)) {
            // Note OFF
            this.pressedKeys.delete(note);
            this.handleNoteOff(note);
        }
        
        if (this.gameActive) {
            this.checkChord();
        }
    }
    
    handleSustainPedal(pressed) {
        console.log(`Sustain pedal: ${pressed ? 'ON' : 'OFF'}`);
        this.sustainPedalPressed = pressed;
        
        // UI„ÅÆÊõ¥Êñ∞
        if (this.elements.pedalState) {
            this.elements.pedalState.textContent = pressed ? 'ON' : 'OFF';
            this.elements.pedalState.className = 'pedal-state ' + (pressed ? 'on' : 'off');
        }
        
        if (!pressed) {
            // „Çµ„Çπ„ÉÜ„Ç£„Éº„É≥„Éö„ÉÄ„É´„ÇíÈõ¢„Åó„ÅüÊôÇ„ÄÅÁ∂≠ÊåÅ„Åï„Çå„Å¶„ÅÑ„ÅüÈü≥„ÇíÂÅúÊ≠¢
            for (const note of this.sustainedNotes) {
                if (!this.pressedKeys.has(note)) {
                    this.stopNote(note);
                    // Ë¶ñË¶öÁöÑË°®Á§∫„ÇÇÁ¢∫ÂÆü„Å´„ÇØ„É™„Ç¢ÔºàÊó¢„Å´„ÇØ„É™„Ç¢„Åï„Çå„Å¶„ÅÑ„Çã„ÅØ„Åö„Å†„ÅåÂøµ„ÅÆ„Åü„ÇÅÔºâ
                    this.updatePianoKeyDisplay(note, false);
                }
            }
            this.sustainedNotes.clear();
        }
    }
    
    handleNoteOff(note) {
        // ÈçµÁõ§„ÅÆË¶ñË¶öÁöÑ„Å™Êäº‰∏ãÁä∂ÊÖã„ÅØÂ∏∏„Å´Ëß£Èô§
        this.updatePianoKeyDisplay(note, false);
        
        if (this.sustainPedalPressed) {
            // „Çµ„Çπ„ÉÜ„Ç£„Éº„É≥„Éö„ÉÄ„É´„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÈü≥„ÅÆ„ÅøÁ∂≠ÊåÅ
            this.sustainedNotes.add(note);
            console.log(`Note ${note} sustained by pedal (visual released)`);
        } else {
            // ÈÄöÂ∏∏„ÅÆ„Éé„Éº„Éà„Ç™„ÉïÂá¶ÁêÜÔºàÈü≥„ÇÇÂÅúÊ≠¢Ôºâ
            this.stopNote(note);
        }
    }
    
    updatePianoKeyDisplay(note, pressed) {
        console.log(`Updating piano key ${note}, pressed: ${pressed}`);
        const key = this.pianoKeys[note];
        if (key) {
            if (pressed) {
                key.classList.add('pressed');
                console.log(`Key ${note} marked as pressed`);
            } else {
                key.classList.remove('pressed');
                console.log(`Key ${note} unmarked as pressed`);
            }
        } else {
            console.log(`Key ${note} not found in piano display`);
        }
    }
    
    clearPianoKeyDisplay() {
        // ÂÖ®„Å¶„ÅÆÈçµÁõ§„Åã„ÇâÊäº‰∏ãÁä∂ÊÖã„ÇíÂâäÈô§
        Object.values(this.pianoKeys).forEach(key => {
            key.classList.remove('pressed');
        });
        console.log('ÂÖ®„Å¶„ÅÆÈçµÁõ§„ÅÆÊäº‰∏ãÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢');
    }
    
    updateMIDIStatus(message, connected) {
        this.elements.midiMessage.textContent = message;
        this.elements.midiStatus.className = connected ? 'midi-status connected' : 'midi-status';
        
        // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇÇÊõ¥Êñ∞
        if (this.elements.statusIndicator) {
            this.elements.statusIndicator.textContent = connected ? 'üü¢' : 'üî¥';
        }
    }
    
    // Ë®≠ÂÆöÁÆ°ÁêÜ„É°„ÇΩ„ÉÉ„Éâ
    loadSettings() {
        const defaultSettings = {
            volume: 100,
            selectedMidiDevice: null
        };
        
        try {
            const savedSettings = localStorage.getItem('chordPracticeSettings');
            if (savedSettings) {
                return { ...defaultSettings, ...JSON.parse(savedSettings) };
            }
        } catch (error) {
            console.warn('Failed to load settings:', error);
        }
        
        return defaultSettings;
    }
    
    saveSettings() {
        try {
            localStorage.setItem('chordPracticeSettings', JSON.stringify(this.settings));
            console.log('Settings saved:', this.settings);
        } catch (error) {
            console.warn('Failed to save settings:', error);
        }
    }
    
    applySettings() {
        // Èü≥ÈáèË®≠ÂÆö„ÅÆÈÅ©Áî®
        if (this.elements.volumeSlider && this.elements.volumeValue) {
            this.elements.volumeSlider.value = this.settings.volume;
            this.elements.volumeValue.textContent = `${this.settings.volume}%`;
            this.updateVolume(this.settings.volume);
        }
        
        // MIDI„Éá„Éê„Ç§„ÇπË®≠ÂÆö„ÅÆÈÅ©Áî®ÔºàMIDI„Ç¢„ÇØ„Çª„ÇπÁ¢∫Á´ãÂæå„Å´ÈÅ©Áî®Ôºâ
        if (this.settings.selectedMidiDevice) {
            setTimeout(() => this.applyMidiDeviceSelection(), 1000);
        }
    }
    
    applyMidiDeviceSelection() {
        if (this.elements.midiDevicesSelect && this.settings.selectedMidiDevice) {
            // ‰øùÂ≠ò„Åï„Çå„Åü„Éá„Éê„Ç§„Çπ„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const options = Array.from(this.elements.midiDevicesSelect.options);
            const targetOption = options.find(option => option.value === this.settings.selectedMidiDevice);
            
            if (targetOption) {
                this.elements.midiDevicesSelect.value = this.settings.selectedMidiDevice;
                this.connectToSelectedDevice();
                console.log('Applied saved MIDI device:', this.settings.selectedMidiDevice);
            } else {
                console.log('Saved MIDI device no longer available:', this.settings.selectedMidiDevice);
                this.settings.selectedMidiDevice = null;
                this.saveSettings();
            }
        }
    }
    
    updateGameButtonVisibility() {
        // MIDI„Éá„Éê„Ç§„Çπ„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Åø„Äå„Ç≤„Éº„É†ÁîªÈù¢„Å∏„Äç„Éú„Çø„É≥„ÇíË°®Á§∫
        if (this.midiInput) {
            this.elements.goToGameBtn.style.display = 'inline-block';
        } else {
            this.elements.goToGameBtn.style.display = 'none';
        }
    }
    
    updateVolume(value) {
        const volume = value / 100;
        if (this.masterVolume) {
            this.masterVolume.gain.setValueAtTime(volume * 3, this.audioContext.currentTime);
        }
        if (this.elements.volumeValue) {
            this.elements.volumeValue.textContent = `${value}%`;
        }
        
        // Ë®≠ÂÆö„Çí‰øùÂ≠ò
        this.settings.volume = parseInt(value);
        this.saveSettings();
        
        console.log(`Volume updated to ${value}% (${(volume * 3).toFixed(2)}x) with limiter protection`);
    }
    
    noteToString(midiNote) {
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const octave = Math.floor(midiNote / 12) - 1;
        const noteName = noteNames[midiNote % 12];
        return `${noteName}${octave}`;
    }
    
    setupEventListeners() {
        this.elements.startBtn.addEventListener('click', () => this.startGame());
        this.elements.restartBtn.addEventListener('click', () => this.restartGame());
        this.elements.midiDevicesSelect.addEventListener('change', (event) => {
            console.log(`Change event triggered, target value: "${event.target.value}"`);
            // Â∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶„ÄÅDOMÊõ¥Êñ∞„ÅÆÁ´∂Âêà„ÇíÈÅø„Åë„Çã
            setTimeout(() => {
                this.connectToSelectedDevice();
            }, 10);
        });
        
        // ÁîªÈù¢ÈÅ∑Áßª„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        this.elements.gameStartBtn.addEventListener('click', () => this.showGameScreen());
        this.elements.settingsBtn.addEventListener('click', () => this.showSettingsScreen());
        this.elements.backToTitleBtn.addEventListener('click', () => this.showTitleScreen());
        this.elements.backToTitleFromGameBtn.addEventListener('click', () => this.showTitleScreen());
        this.elements.goToGameBtn.addEventListener('click', () => this.showGameScreen());
        
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        window.addEventListener('resize', () => this.handleWindowResize());
        
        // Èü≥Èáè„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        if (this.elements.volumeSlider) {
            this.elements.volumeSlider.addEventListener('input', (event) => this.updateVolume(event.target.value));
        }
        
        // „Çµ„Çπ„ÉÜ„Ç£„Éº„É≥„Éö„ÉÄ„É´„ÅÆÂàùÊúüÁä∂ÊÖãË®≠ÂÆö
        if (this.elements.pedalState) {
            this.elements.pedalState.textContent = 'OFF';
            this.elements.pedalState.className = 'pedal-state off';
        }
        
        // „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅÆË®≠ÂÆö
        if (this.elements.versionInfo) {
            this.elements.versionInfo.textContent = `v${ChordPracticeApp.VERSION}`;
        }
    }
    
    handleWindowResize() {
        // „Ç≤„Éº„É†ÁîªÈù¢„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈçµÁõ§„ÇíÂÜç‰ΩúÊàê
        if (this.elements.gameScreen.style.display === 'block') {
            // Â∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶„ÄÅ„É™„Çµ„Ç§„Ç∫„ÅåÂÆå‰∫Ü„Åó„Å¶„Åã„ÇâÂÜçË®àÁÆó
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
                this.createPianoKeyboard();
                this.updateRangeDisplay();
            }, 100);
        }
    }
    
    showTitleScreen() {
        this.elements.titleScreen.style.display = 'block';
        this.elements.settingsScreen.style.display = 'none';
        this.elements.gameScreen.style.display = 'none';
        
        // „Ç≤„Éº„É†„ÇíÂÅúÊ≠¢
        if (this.gameActive) {
            this.stopGame();
        }
    }
    
    showSettingsScreen() {
        this.elements.titleScreen.style.display = 'none';
        this.elements.settingsScreen.style.display = 'block';
        this.elements.gameScreen.style.display = 'none';
        this.updateGameButtonVisibility();
    }
    
    showGameScreen() {
        // MIDI„Éá„Éê„Ç§„Çπ„ÅåÂÆüÈöõ„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´ÊÉÖÂ†±„Åå„ÅÇ„Å£„Å¶„ÇÇ„ÄÅÂÆüÈöõ„ÅÆ„Éá„Éê„Ç§„ÇπÊé•Á∂ö„ÇíÁ¢∫Ë™ç
        let hasConnectedDevice = false;
        if (this.midiAccess) {
            const inputs = Array.from(this.midiAccess.inputs.values());
            hasConnectedDevice = inputs.some(input => input.connection === 'open' || input.state === 'connected');
        }
        
        if (!hasConnectedDevice) {
            // ÂÆüÈöõ„Å´MIDI„Éá„Éê„Ç§„Çπ„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÁí∞Â¢ÉË®≠ÂÆöÁîªÈù¢„Å´ÈÅ∑Áßª
            this.showSettingsScreen();
            this.updateMIDIStatus('„Ç≤„Éº„É†„ÇíÈñãÂßã„Åô„Çã„Å´„ÅØMIDI„Éá„Éê„Ç§„Çπ„ÇíÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', false);
            return;
        }
        
        this.elements.titleScreen.style.display = 'none';
        this.elements.settingsScreen.style.display = 'none';
        this.elements.gameScreen.style.display = 'block';
        
        // „Ç≤„Éº„É†UI„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        this.resetGameUI();
        
        // „Ç≤„Éº„É†ÁîªÈù¢„Å´ÁßªË°åÊôÇ„Å´ÈçµÁõ§„ÇíÂÜç‰ΩúÊàê„Åó„Å¶ÁØÑÂõ≤„ÇíË°®Á§∫
        setTimeout(() => {
            this.createPianoKeyboard();
            this.generateRandomRange();
        }, 100);
    }
    
    resetGameUI() {
        // „Ç≤„Éº„É†„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        this.gameActive = false;
        this.waitingForNextQuestion = false;
        if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
        }
        
        // ÊåáÁ§∫Êñá„ÇíÈùûË°®Á§∫
        if (this.elements.chordInstruction) {
            this.elements.chordInstruction.style.display = 'none';
        }
        
        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Çí„ÇØ„É™„Ç¢
        if (this.countdownInterval) {
            clearInterval(this.countdownInterval);
            this.countdownInterval = null;
        }
        
        // „Çπ„Ç≥„Ç¢„Å®„Çø„Ç§„Éû„Éº„Çí„É™„Çª„ÉÉ„Éà
        this.score = 0;
        this.timeLeft = 60;
        this.elements.score.textContent = this.score;
        this.elements.timer.textContent = this.timeLeft;
        
        // „Éú„Çø„É≥„ÅÆË°®Á§∫Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        this.elements.startBtn.style.display = 'inline-block';
        this.elements.restartBtn.style.display = 'none';
        
        // UI„ÅÆË°®Á§∫Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
        this.elements.resultDisplay.style.display = 'none';
        this.elements.chordDisplay.style.display = 'block';
        this.elements.currentChord.textContent = '„Çπ„Çø„Éº„Éà„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        this.elements.currentChord.style.opacity = '1';
        this.elements.countdownDisplay.style.display = 'none';
        this.elements.correctIndicator.style.display = 'none';
        
        // ÁµêÊûú„Ç®„É™„Ç¢„ÇÇÈùûË°®Á§∫„Å´„Åô„Çã
        this.elements.resultArea.style.display = 'none';
    }
    
    async startGame() {
        this.elements.startBtn.style.display = 'none';
        this.elements.restartBtn.style.display = 'inline-block';
        this.elements.resultArea.style.display = 'none';
        
        // „Ç§„É≥„É©„Ç§„É≥ÁµêÊûúË°®Á§∫„ÇíÈö†„Åó„Å¶ÂíåÈü≥Ë°®Á§∫„ÇíË°®Á§∫
        this.elements.resultDisplay.style.display = 'none';
        this.elements.chordDisplay.style.display = 'block';
        
        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÈñãÂßã
        await this.startCountdown();
        
        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Âæå„Å´„Ç≤„Éº„É†ÈñãÂßã
        this.gameActive = true;
        this.score = 0;
        this.timeLeft = 60;
        
        // „Ç≤„Éº„É†ÈñãÂßãÊôÇ„Å´ÊåáÁ§∫Êñá„ÇíË°®Á§∫
        if (this.elements.chordInstruction) {
            this.elements.chordInstruction.style.display = 'block';
        }
        
        this.generateRandomRange();
        this.nextChord();
        this.startTimer();
    }
    
    async startCountdown() {
        return new Promise((resolve) => {
            let countdown = 3;
            this.elements.countdownDisplay.style.display = 'flex';
            this.elements.currentChord.style.opacity = '0.3';
            
            // ÊúÄÂàù„ÅÆÊï∞Â≠ó„ÇíÂç≥Â∫ß„Å´Ë°®Á§∫
            this.elements.countdownNumber.textContent = countdown;
            this.elements.countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
            
            this.countdownInterval = setInterval(() => {
                countdown--;
                
                if (countdown > 0) {
                    this.elements.countdownNumber.textContent = countdown;
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂº∑Âà∂ÁöÑ„Å´„É™„Çª„ÉÉ„Éà
                    this.elements.countdownNumber.style.animation = 'none';
                    this.elements.countdownNumber.offsetHeight; // Âº∑Âà∂„É™„Éï„É≠„Éº
                    this.elements.countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
                } else {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                    this.elements.countdownDisplay.style.display = 'none';
                    this.elements.currentChord.style.opacity = '1';
                    resolve();
                }
            }, 1000);
        });
    }
    
    restartGame() {
        this.stopGame();
        this.startGame();
    }
    
    stopGame() {
        this.gameActive = false;
        if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
        }
        
        this.elements.startBtn.style.display = 'inline-block';
        this.elements.restartBtn.style.display = 'none';
        
        // ÊåáÁ§∫Êñá„ÇíÈùûË°®Á§∫
        if (this.elements.chordInstruction) {
            this.elements.chordInstruction.style.display = 'none';
        }
        
        // ÂíåÈü≥Ë°®Á§∫„ÇíÈö†„Åó„Å¶„Ç§„É≥„É©„Ç§„É≥ÁµêÊûúË°®Á§∫„ÇíË°®Á§∫
        this.elements.chordDisplay.style.display = 'none';
        this.elements.resultDisplay.style.display = 'block';
        this.elements.finalScoreInline.textContent = this.score;
        
        // ÁµêÊûú„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË®≠ÂÆö
        let message = '„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„ÅüÔºÅ';
        if (this.score >= 15) {
            message = 'Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅÂÆåÁíß„Å™ÊºîÂ•è„Åß„ÅôÔºÅ';
        } else if (this.score >= 10) {
            message = '„Å®„Å¶„ÇÇËâØ„ÅÑÊºîÂ•è„Åß„Åó„ÅüÔºÅ';
        } else if (this.score >= 5) {
            message = 'ËâØ„ÅÑË™øÂ≠ê„Åß„ÅôÔºÅ';
        }
        this.elements.resultMessageInline.textContent = message;
    }
    
    startTimer() {
        this.updateTimer();
        this.timer = setInterval(() => {
            this.timeLeft--;
            this.updateTimer();
            
            if (this.timeLeft <= 0) {
                this.stopGame();
            }
        }, 1000);
    }
    
    updateTimer() {
        this.elements.timer.textContent = this.timeLeft;
    }
    
    generateRandomRange() {
        // Âõ∫ÂÆöÁØÑÂõ≤: Â∑¶ÊâãC2-C3„ÄÅÂè≥ÊâãC4-C5
        this.currentRange = {
            leftHandMin: 36,  // C2
            leftHandMax: 48,  // C3
            rightHandMin: 60, // C4
            rightHandMax: 72  // C5
        };
        
        this.updateRangeDisplay();
    }
    
    updateRangeDisplay() {
        // Ââç„ÅÆÁØÑÂõ≤Ë°®Á§∫„Çí„ÇØ„É™„Ç¢
        Object.values(this.pianoKeys).forEach(key => {
            key.classList.remove('left-hand-range', 'right-hand-range');
        });
        
        if (!this.currentRange) return;
        
        // Â∑¶ÊâãÁØÑÂõ≤„ÇíÈùíËâ≤„ÅßË°®Á§∫ÔºàÁôΩÈçµ„ÅÆ„ÅøÔºâ
        for (let note = this.currentRange.leftHandMin; note <= this.currentRange.leftHandMax; note++) {
            const key = this.pianoKeys[note];
            if (key && key.classList.contains('white')) {
                key.classList.add('left-hand-range');
            }
        }
        
        // Âè≥ÊâãÁØÑÂõ≤„ÇíÁ∑ëËâ≤„ÅßË°®Á§∫ÔºàÁôΩÈçµ„ÅÆ„ÅøÔºâ
        for (let note = this.currentRange.rightHandMin; note <= this.currentRange.rightHandMax; note++) {
            const key = this.pianoKeys[note];
            if (key && key.classList.contains('white')) {
                key.classList.add('right-hand-range');
            }
        }
    }
    
    nextChord() {
        // ÈÄ£Á∂ö„Åó„Å¶Âêå„Åò„Ç≥„Éº„Éâ„ÅåÂá∫È°å„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
        let newChord;
        do {
            newChord = this.chords[Math.floor(Math.random() * this.chords.length)];
        } while (this.currentChord && newChord.name === this.currentChord.name && this.chords.length > 1);
        
        this.currentChord = newChord;
        this.elements.currentChord.textContent = this.currentChord.name;
        
        // Reset waiting state to allow new answers
        this.waitingForNextQuestion = false;
        
        // „Ç≥„Éº„ÉâË°®Á§∫„ÅÆËâ≤„ÇíÈÄöÂ∏∏„Å´Êàª„Åô
        this.elements.currentChord.style.color = '#2d3748';
        
        // Ê≠£Ëß£„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„ÉàÔºàÈÄ£Á∂öÊ≠£Ëß£Èò≤Ê≠¢Ôºâ
        this.justAnswered = true;
        setTimeout(() => {
            this.justAnswered = false;
        }, 200);
    }
    
    checkChord() {
        if (this.pressedKeys.size === 0 || this.justAnswered || this.waitingForNextQuestion) return;
        
        const pressedNotes = Array.from(this.pressedKeys);
        const leftHandNotes = pressedNotes.filter(note => 
            note >= this.currentRange.leftHandMin && note <= this.currentRange.leftHandMax
        );
        const rightHandNotes = pressedNotes.filter(note => 
            note >= this.currentRange.rightHandMin && note <= this.currentRange.rightHandMax
        );
        
        if (leftHandNotes.length === 0 || rightHandNotes.length === 0) return;
        
        const leftHandNote = leftHandNotes[0] % 12;
        const rightHandNotesMod = rightHandNotes.map(note => note % 12);
        
        const chordRoot = this.currentChord.notes[0];
        const chordNotes = new Set(this.currentChord.notes);
        
        if (leftHandNote === chordRoot && 
            rightHandNotesMod.length === 3 && 
            rightHandNotesMod.every(note => chordNotes.has(note)) &&
            new Set(rightHandNotesMod).size === 3) {
            
            this.correctAnswer();
        }
    }
    
    async playCorrectAnswerSound() {
        try {
            console.log('playCorrectAnswerSoundÈñãÂßã');
            
            // Ê≠£Ëß£Èü≥Â∞ÇÁî®„ÅÆMP3„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®
            const correctSoundPath = 'mp3/correct001.mp3';
            console.log('Ê≠£Ëß£Èü≥„Éï„Ç°„Ç§„É´„Éë„Çπ:', correctSoundPath);
            
            // „Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
            if (!this.audioContext) {
                console.error('„Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            if (this.audioContext.state === 'suspended') {
                console.log('„Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÜçÈñã„Åó„Åæ„Åô');
                await this.audioContext.resume();
            }
            
            // „Ç™„Éº„Éá„Ç£„Ç™„Éê„ÉÉ„Éï„Ç°„ÅåÊó¢„Å´„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (!this.audioBuffers.has(correctSoundPath)) {
                console.log('Ê≠£Ëß£Èü≥„Éï„Ç°„Ç§„É´„Çí„É≠„Éº„Éâ„Åó„Åæ„Åô');
                await this.loadSingleAudioFile(correctSoundPath);
            }
            
            const buffer = this.audioBuffers.get(correctSoundPath);
            if (buffer) {
                console.log('Ê≠£Ëß£Èü≥„ÇíÂÜçÁîüÈñãÂßã');
                const source = this.audioContext.createBufferSource();
                const gainNode = this.audioContext.createGain();
                gainNode.gain.setValueAtTime(0.06, this.audioContext.currentTime); // Èü≥Èáè„Çí6%„Å´
                
                source.buffer = buffer;
                source.connect(gainNode);
                gainNode.connect(this.masterVolume);
                source.start();
                
                console.log('Ê≠£Ëß£Èü≥„ÇíÂÜçÁîü„Åó„Åæ„Åó„Åü');
            } else {
                console.error('Ê≠£Ëß£Èü≥„ÅÆ„Ç™„Éº„Éá„Ç£„Ç™„Éê„ÉÉ„Éï„Ç°„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
        } catch (error) {
            console.error('Ê≠£Ëß£Èü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        }
    }
    
    async correctAnswer() {
        this.score++;
        this.elements.score.textContent = this.score;
        
        // Set waiting state to prevent incorrect answers during delay
        this.waitingForNextQuestion = true;
        
        // ÂæÖÊ©ü‰∏≠„ÅØ„Ç≥„Éº„ÉâË°®Á§∫„ÇíÁÅ∞Ëâ≤„Å´„Åô„Çã
        this.elements.currentChord.style.color = '#a0aec0';
        
        console.log('Ê≠£Ëß£ÔºÅÊ≠£Ëß£Èü≥„ÇíÂÜçÁîü„Åó„Åæ„Åô');
        
        // Ê≠£Ëß£Èü≥„ÇíËá™ÂãïÊºîÂ•è
        try {
            await this.playCorrectAnswerSound();
        } catch (error) {
            console.error('Ê≠£Ëß£Èü≥„ÅÆÂÜçÁîü„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü:', error);
        }
        
        this.elements.chordDisplay.classList.add('correct');
        
        // Ê≠£Ëß£„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíË°®Á§∫
        this.elements.correctIndicator.style.display = 'flex';
        
        // 1ÁßíÂæå„Å´Ê¨°„ÅÆÂïèÈ°å„Å´ÁßªË°å
        setTimeout(() => {
            this.elements.chordDisplay.classList.remove('correct');
            this.elements.correctIndicator.style.display = 'none';
            this.nextChord();
        }, 1000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new ChordPracticeApp();
});
    </script>
</body>
</html>